<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ClaraVerse Table Persistence</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-info { background: #6366f1; color: white; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .status-panel {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Styles pour simuler ClaraVerse */
        .markdown {
            background: white;
            padding: 20px;
            border-radius: 8px;
        }

        .prose {
            max-width: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        table.min-w-full {
            min-width: 100%;
        }

        table.border {
            border: 1px solid #d1d5db;
        }

        table.border-gray-200 {
            border-color: #e5e7eb;
        }

        table.dark\:border-gray-700 {
            border-color: #374151;
        }

        table.rounded-lg {
            border-radius: 0.5rem;
        }

        th, td {
            border: 1px solid #d1d5db;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f9fafb;
            font-weight: bold;
        }

        .table-container {
            overflow-x: auto;
            margin: 10px 0;
        }

        .claraverse-conso-table {
            border: 2px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .claraverse-conso-table th {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .log-entry {
            margin: 2px 0;
            font-size: 12px;
        }

        .error { color: #ef4444; }
        .success { color: #10b981; }
        .info { color: #6366f1; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§ª Test ClaraVerse Table Persistence</h1>
        <p>Validation du systÃ¨me de persistance DOM & localStorage</p>
    </div>

    <div class="test-section">
        <h2>ğŸ›ï¸ ContrÃ´les de Test</h2>
        <div class="test-controls">
            <button class="btn btn-primary" onclick="initSystem()">ğŸš€ Initialiser SystÃ¨me</button>
            <button class="btn btn-success" onclick="scanTables()">ğŸ” Scanner Tables</button>
            <button class="btn btn-info" onclick="createTestTables()">ğŸ“Š CrÃ©er Tables Test</button>
            <button class="btn btn-warning" onclick="testPersistence()">ğŸ’¾ Test Persistance</button>
            <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ Vider Tout</button>
        </div>

        <div class="test-controls">
            <button class="btn btn-info" onclick="exportData()">ğŸ“¤ Exporter</button>
            <button class="btn btn-info" onclick="showStatus()">ğŸ“Š Statut</button>
            <button class="btn btn-info" onclick="showHelp()">â“ Aide</button>
            <button class="btn btn-success" onclick="runFullTest()">ğŸ§ª Test Complet</button>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š Console de Logs</h2>
        <div id="logConsole" class="status-panel">
            <div class="log-entry info">ğŸ”„ En attente d'initialisation...</div>
        </div>
        <button class="btn btn-warning" onclick="clearLogs()">ğŸ§¹ Vider Console</button>
    </div>

    <!-- Tables de Test Simulant ClaraVerse -->
    <div class="test-section">
        <h2>ğŸ“‹ Tables de Test ClaraVerse</h2>

        <!-- Table de Pointage (SimulÃ©e) -->
        <div class="markdown prose prose-base dark:prose-invert max-w-none">
            <h3>Table de Pointage</h3>
            <div class="table-container">
                <table class="min-w-full border border-gray-200 dark:border-gray-700 rounded-lg" data-table-id="pointage_test">
                    <thead>
                        <tr>
                            <th>CritÃ¨re</th>
                            <th>Ã‰cart</th>
                            <th>Conclusion</th>
                            <th>CTR 1</th>
                            <th>CTR 2</th>
                            <th>CTR 3</th>
                            <th>Assertion</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Test A</td>
                            <td>0.5</td>
                            <td>Acceptable</td>
                            <td>85%</td>
                            <td>90%</td>
                            <td>88%</td>
                            <td>ValidÃ©</td>
                        </tr>
                        <tr>
                            <td>Test B</td>
                            <td>1.2</td>
                            <td>Ã€ rÃ©viser</td>
                            <td>75%</td>
                            <td>80%</td>
                            <td>78%</td>
                            <td>En cours</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Table de Consolidation -->
        <div class="markdown prose prose-base dark:prose-invert max-w-none">
            <h3>Table de Consolidation</h3>
            <table class="claraverse-conso-table" data-table-id="conso_test">
                <thead>
                    <tr>
                        <th>ğŸ“Š Table de Consolidation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="conso-content" style="padding: 8px; background: #f8f9fa; min-height: 50px;">
                            â³ En attente de consolidation...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Table de RÃ©sultats -->
        <div class="markdown prose prose-base dark:prose-invert max-w-none">
            <h3>Table de RÃ©sultats</h3>
            <table class="min-w-full border border-gray-200 dark:border-gray-700 rounded-lg" data-table-id="resultats_test">
                <thead>
                    <tr>
                        <th>RÃ©sultats</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Conclusion finale du test</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Conteneur pour tables dynamiques -->
    <div class="test-section">
        <h2>ğŸ”„ Tables Dynamiques</h2>
        <div id="dynamicTablesContainer" class="markdown prose prose-base dark:prose-invert max-w-none">
            <!-- Les tables seront ajoutÃ©es ici dynamiquement -->
        </div>
    </div>

    <!-- Chargement du script dev.js -->
    <script src="dev.js"></script>

    <script>
        // SystÃ¨me de logging pour les tests
        let logCounter = 0;

        function log(message, type = 'info') {
            const logConsole = document.getElementById('logConsole');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${++logCounter}] ${new Date().toLocaleTimeString()} - ${message}`;
            logConsole.appendChild(entry);
            logConsole.scrollTop = logConsole.scrollHeight;

            // Aussi dans la console navigateur
            console.log(`[TEST] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logConsole').innerHTML = '';
            logCounter = 0;
            log('Console vidÃ©e', 'info');
        }

        // Fonctions de test
        function initSystem() {
            log('ğŸš€ Initialisation du systÃ¨me...', 'info');

            // VÃ©rifier si le systÃ¨me est chargÃ©
            if (typeof window.claraverse !== 'undefined') {
                log('âœ… ClaraVerse Table Manager dÃ©tectÃ©', 'success');
                log('ğŸ“Š Status: ' + JSON.stringify(window.claraverse.status()), 'info');
            } else {
                log('âŒ ClaraVerse Table Manager non trouvÃ©', 'error');
                log('ğŸ”„ Tentative de rechargement du script...', 'warning');

                // Recharger le script
                const script = document.createElement('script');
                script.src = 'dev.js';
                script.onload = () => {
                    log('âœ… Script rechargÃ© avec succÃ¨s', 'success');
                };
                script.onerror = () => {
                    log('âŒ Erreur lors du rechargement du script', 'error');
                };
                document.head.appendChild(script);
            }
        }

        function scanTables() {
            log('ğŸ” Lancement du scan des tables...', 'info');

            if (typeof window.claraverse !== 'undefined') {
                window.claraverse.scan();
                log('âœ… Scan terminÃ©', 'success');

                setTimeout(() => {
                    const status = window.claraverse.status();
                    log(`ğŸ“Š Tables traitÃ©es: ${status.processedTables}`, 'info');
                    log(`ğŸ’¾ Cellules sauvegardÃ©es: ${status.storedCells}`, 'info');
                }, 1000);
            } else {
                log('âŒ SystÃ¨me non initialisÃ©', 'error');
            }
        }

        function createTestTables() {
            log('ğŸ“Š CrÃ©ation de tables de test...', 'info');

            const container = document.getElementById('dynamicTablesContainer');
            const timestamp = Date.now();

            const tableHTML = `
                <h4>Table Dynamique ${timestamp}</h4>
                <table class="min-w-full border border-gray-200 dark:border-gray-700 rounded-lg" data-table-id="dynamic_${timestamp}">
                    <thead>
                        <tr>
                            <th>Colonne A</th>
                            <th>Colonne B</th>
                            <th>Colonne C</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Valeur 1</td>
                            <td>Valeur 2</td>
                            <td>Valeur 3</td>
                        </tr>
                        <tr>
                            <td>Test A</td>
                            <td>Test B</td>
                            <td>Test C</td>
                        </tr>
                    </tbody>
                </table>
            `;

            container.innerHTML += tableHTML;
            log('âœ… Table dynamique crÃ©Ã©e', 'success');

            // Relancer le scan pour dÃ©tecter la nouvelle table
            setTimeout(() => {
                scanTables();
            }, 500);
        }

        function testPersistence() {
            log('ğŸ’¾ Test de persistance...', 'info');

            // Tester la modification d'une cellule
            const firstCell = document.querySelector('td');
            if (firstCell) {
                const originalValue = firstCell.textContent;
                const testValue = `TEST_${Date.now()}`;

                log(`ğŸ“ Modification cellule: "${originalValue}" â†’ "${testValue}"`, 'info');

                // Simuler une modification utilisateur
                firstCell.focus();
                firstCell.textContent = testValue;

                // DÃ©clencher l'Ã©vÃ©nement input
                firstCell.dispatchEvent(new Event('input', { bubbles: true }));

                log('âœ… Modification effectuÃ©e, sauvegarde en cours...', 'success');

                // VÃ©rifier la sauvegarde aprÃ¨s 1 seconde
                setTimeout(() => {
                    const stored = localStorage.getItem(`claraverse_table_${firstCell.dataset.cellId || 'unknown'}`);
                    if (stored) {
                        log('âœ… Persistance confirmÃ©e dans localStorage', 'success');
                    } else {
                        log('âš ï¸ Persistance non confirmÃ©e', 'warning');
                    }
                }, 1000);
            } else {
                log('âŒ Aucune cellule trouvÃ©e pour le test', 'error');
            }
        }

        function clearAll() {
            log('ğŸ—‘ï¸ Vidage de toutes les donnÃ©es...', 'warning');

            if (typeof window.claraverse !== 'undefined') {
                window.claraverse.clear();
                log('âœ… DonnÃ©es vidÃ©es', 'success');
            }

            // Vider aussi le conteneur dynamique
            document.getElementById('dynamicTablesContainer').innerHTML = '';
            log('âœ… Tables dynamiques supprimÃ©es', 'success');
        }

        function exportData() {
            log('ğŸ“¤ Export des donnÃ©es...', 'info');

            if (typeof window.claraverse !== 'undefined') {
                window.claraverse.export();
                log('âœ… Export terminÃ©', 'success');
            } else {
                log('âŒ SystÃ¨me non initialisÃ©', 'error');
            }
        }

        function showStatus() {
            log('ğŸ“Š Affichage du statut...', 'info');

            if (typeof window.claraverse !== 'undefined') {
                const status = window.claraverse.status();
                log(`ğŸ”§ InitialisÃ©: ${status.initialized}`, 'info');
                log(`ğŸ“‹ Tables traitÃ©es: ${status.processedTables}`, 'info');
                log(`ğŸ’¾ Cellules stockÃ©es: ${status.storedCells}`, 'info');
                log(`ğŸ‘ï¸ Observers: ${status.observers}`, 'info');
                log(`ğŸ§  Tables en mÃ©moire: ${status.memoryTables}`, 'info');
            } else {
                log('âŒ SystÃ¨me non initialisÃ©', 'error');
            }
        }

        function showHelp() {
            log('â“ Affichage de l\'aide...', 'info');

            if (typeof window.claraverse !== 'undefined') {
                window.claraverse.help();
                log('âœ… Aide affichÃ©e dans la console navigateur', 'success');
            } else {
                log('âŒ SystÃ¨me non initialisÃ©', 'error');
            }
        }

        function runFullTest() {
            log('ğŸ§ª Lancement du test complet...', 'info');

            let step = 1;
            const totalSteps = 6;

            function nextStep(fn, delay = 2000) {
                setTimeout(() => {
                    log(`ğŸ“‹ Ã‰tape ${step}/${totalSteps}`, 'info');
                    fn();
                    step++;
                }, delay);
            }

            // SÃ©quence de test automatique
            nextStep(() => initSystem(), 0);
            nextStep(() => scanTables(), 2000);
            nextStep(() => createTestTables(), 2000);
            nextStep(() => testPersistence(), 2000);
            nextStep(() => showStatus(), 2000);
            nextStep(() => {
                log('ğŸ‰ Test complet terminÃ© !', 'success');
                log('ğŸ” VÃ©rifiez les rÃ©sultats dans la console navigateur', 'info');
            }, 2000);
        }

        // Initialisation automatique au chargement
        window.addEventListener('load', () => {
            log('ğŸŒ Page chargÃ©e, initialisation automatique...', 'info');
            setTimeout(() => {
                initSystem();
            }, 1000);
        });

        // Ã‰couter les notifications du systÃ¨me
        window.addEventListener('claraverse-notification', (event) => {
            log(`ğŸ“¢ Notification: ${event.detail.message}`, event.detail.type || 'info');
        });

        // Override console.log pour capturer les logs du systÃ¨me
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            // Si le log vient du systÃ¨me ClaraVerse
            const message = args.join(' ');
            if (message.includes('ClaraVerse') || message.includes('ğŸ”¥') || message.includes('ğŸ’¾')) {
                log(message, 'info');
            }

            // Appel normal
            originalConsoleLog.apply(console, args);
        };
    </script>
</body>
</html>
