<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sauvegarde Persistante</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .test-table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        .test-table th,
        .test-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .test-table th {
            background-color: #f2f2f2;
        }

        .prose {
            max-width: none;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        button.success {
            background: #28a745;
        }

        button.warning {
            background: #ffc107;
            color: #212529;
        }

        .logs-container {
            background: #1e1e1e;
            color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-success {
            color: #4CAF50;
        }

        .log-error {
            color: #f44336;
        }

        .log-warning {
            color: #ff9800;
        }

        .log-info {
            color: #2196F3;
        }

        .editable {
            background: #fff3cd;
            border: 2px dashed #ffc107;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ’¾ Test Sauvegarde Persistante</h1>
        <p>Test pour diagnostiquer pourquoi les modifications des anciennes tables ne sont pas sauvegardÃ©es</p>

        <div class="container">
            <h2>ğŸ¯ Tests de Sauvegarde</h2>
            <button onclick="testSauvegardeAncienneTable()">ğŸ›ï¸ Test Ancienne Table</button>
            <button onclick="testSauvegardeNouvelleTable()">ğŸ†• Test Nouvelle Table</button>
            <button onclick="testModificationPersistante()">âœï¸ Test Modification</button>
            <button onclick="simulerRechargemet()">ğŸ”„ Simuler Rechargement</button>
            <button class="warning" onclick="forceAllSaves()">ğŸ’¾ Forcer Sauvegardes</button>
            <button onclick="clearLogs()">ğŸ§¹ Effacer</button>
        </div>

        <div class="container">
            <h2>ğŸ“‹ Tables de Test</h2>

            <h3>ğŸ›ï¸ Ancienne Table (style conso.js)</h3>
            <div class="prose prose-base dark:prose-invert max-w-none">
                <table id="table_ancien_test" data-menu-table-id="table_ancien_test" class="test-table min-w-full">
                    <thead>
                        <tr>
                            <th>Ancienne</th>
                            <th>Valeur</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td contenteditable="true" class="editable">Modifiez-moi !</td>
                            <td contenteditable="true" class="editable">Ancienne donnÃ©e</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>ğŸ†• Nouvelle Table (style menu_storage.js)</h3>
            <div class="prose prose-base dark:prose-invert max-w-none">
                <table id="table_nouveau_test" class="test-table min-w-full">
                    <thead>
                        <tr>
                            <th>Nouvelle</th>
                            <th>Valeur</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td contenteditable="true" class="editable">Modifiez-moi aussi !</td>
                            <td contenteditable="true" class="editable">Nouvelle donnÃ©e</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="container">
            <h2>ğŸ“Š Logs</h2>
            <div id="logs-display" class="logs-container">
                <div class="log-entry log-info">[INIT] Test sauvegarde persistante chargÃ©</div>
            </div>
        </div>
    </div>

    <!-- Charger les scripts -->
    <script src="menu_storage.js"></script>
    <script src="correction-universelle.js"></script>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;

            const logsContainer = document.getElementById('logs-display');
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs-display').innerHTML = '';
            log('Logs effacÃ©s', 'info');
        }

        function getStorageKeys() {
            const keys = Object.keys(localStorage);
            return {
                ancien: keys.filter(key => key.startsWith('table_') || key.includes('claraverse_consolidated')),
                nouveau: keys.filter(key => key.startsWith('claraverse_table_temp_')),
                total: keys.filter(key => key.includes('claraverse') || key.startsWith('table_'))
            };
        }

        async function testSauvegardeAncienneTable() {
            log('ğŸ›ï¸ === TEST SAUVEGARDE ANCIENNE TABLE ===', 'info');

            try {
                const table = document.getElementById('table_ancien_test');
                const firstCell = table.querySelector('td');
                const testContent = 'ANCIEN_MODIFIE_' + Date.now();

                log('ğŸ“Š Ã‰tat initial du localStorage:', 'info');
                const initialKeys = getStorageKeys();
                log(`  Ancien systÃ¨me: ${initialKeys.ancien.length} clÃ©s`, 'info');
                log(`  Nouveau systÃ¨me: ${initialKeys.nouveau.length} clÃ©s`, 'info');

                // Modifier le contenu
                firstCell.textContent = testContent;
                log(`ğŸ“ Contenu modifiÃ©: "${testContent}"`, 'info');

                // Essayer diffÃ©rentes mÃ©thodes de sauvegarde
                log('ğŸ’¾ Tentatives de sauvegarde...', 'info');

                // 1. Nouveau systÃ¨me
                if (window.claraverseStorageAPI) {
                    const newSave = window.claraverseStorageAPI.saveTable(table);
                    log(`  Nouveau systÃ¨me: ${newSave ? 'SUCCÃˆS' : 'Ã‰CHEC'}`, newSave ? 'success' : 'error');
                }

                // 2. Ancien systÃ¨me (si disponible)
                if (window.saveTableHTMLNow) {
                    const oldSave = window.saveTableHTMLNow(table);
                    log(`  Ancien systÃ¨me: ${oldSave ? 'SUCCÃˆS' : 'Ã‰CHEC'}`, oldSave ? 'success' : 'error');
                }

                // 3. SystÃ¨me consolidÃ© (si disponible)
                if (window.claraverseSyncAPI && window.claraverseSyncAPI.saveTable) {
                    const syncSave = window.claraverseSyncAPI.saveTable(table);
                    log(`  SystÃ¨me sync: ${syncSave ? 'SUCCÃˆS' : 'Ã‰CHEC'}`, syncSave ? 'success' : 'error');
                }

                // VÃ©rifier les changements dans localStorage
                setTimeout(() => {
                    const finalKeys = getStorageKeys();
                    log('ğŸ“Š Ã‰tat final du localStorage:', 'info');
                    log(`  Ancien systÃ¨me: ${finalKeys.ancien.length} clÃ©s (+${finalKeys.ancien.length - initialKeys.ancien.length})`, 'info');
                    log(`  Nouveau systÃ¨me: ${finalKeys.nouveau.length} clÃ©s (+${finalKeys.nouveau.length - initialKeys.nouveau.length})`, 'info');

                    // Chercher les donnÃ©es de cette table
                    const tableId = table.getAttribute('data-menu-table-id') || table.id;
                    log(`ğŸ” Recherche donnÃ©es pour ID: ${tableId}`, 'info');

                    let found = false;
                    finalKeys.total.forEach(key => {
                        if (key.includes(tableId)) {
                            const data = localStorage.getItem(key);
                            if (data && data.includes(testContent)) {
                                log(`âœ… DonnÃ©es trouvÃ©es dans: ${key}`, 'success');
                                found = true;
                            }
                        }
                    });

                    if (!found) {
                        log('âŒ Aucune donnÃ©e persistante trouvÃ©e pour cette table', 'error');
                    }
                }, 100);

            } catch (error) {
                log(`âŒ ERREUR: ${error.message}`, 'error');
            }
        }

        async function testSauvegardeNouvelleTable() {
            log('ğŸ†• === TEST SAUVEGARDE NOUVELLE TABLE ===', 'info');

            try {
                const table = document.getElementById('table_nouveau_test');
                const firstCell = table.querySelector('td');
                const testContent = 'NOUVEAU_MODIFIE_' + Date.now();

                // Nettoyer les anciens IDs
                table.removeAttribute('data-robust-table-id');
                table.removeAttribute('data-menu-table-id');

                firstCell.textContent = testContent;
                log(`ğŸ“ Contenu modifiÃ©: "${testContent}"`, 'info');

                // Sauvegarder avec le nouveau systÃ¨me
                const saveResult = window.claraverseStorageAPI.saveTable(table);
                log(`ğŸ’¾ Sauvegarde nouveau systÃ¨me: ${saveResult ? 'SUCCÃˆS' : 'Ã‰CHEC'}`, saveResult ? 'success' : 'error');

                if (saveResult) {
                    const tableId = table.getAttribute('data-robust-table-id');
                    log(`ğŸ”‘ ID gÃ©nÃ©rÃ©: ${tableId ? tableId.substring(0, 30) + '...' : 'AUCUN'}`, 'info');

                    if (tableId) {
                        const savedData = localStorage.getItem(tableId);
                        if (savedData && savedData.includes(testContent)) {
                            log('âœ… DonnÃ©es persistantes confirmÃ©es', 'success');
                        } else {
                            log('âŒ DonnÃ©es non persistantes', 'error');
                        }
                    }
                }

            } catch (error) {
                log(`âŒ ERREUR: ${error.message}`, 'error');
            }
        }

        async function testModificationPersistante() {
            log('âœï¸ === TEST MODIFICATION PERSISTANTE ===', 'info');

            try {
                const table = document.getElementById('table_ancien_test');
                const firstCell = table.querySelector('td');
                const originalContent = firstCell.textContent;
                const modifiedContent = 'MODIFICATION_PERSISTANTE_' + Date.now();

                log(`ğŸ“‹ Contenu original: "${originalContent}"`, 'info');

                // Modifier
                firstCell.textContent = modifiedContent;
                log(`ğŸ“ Contenu modifiÃ©: "${modifiedContent}"`, 'info');

                // Forcer la sauvegarde avec tous les systÃ¨mes disponibles
                log('ğŸ’¾ ForÃ§age sauvegarde avec tous les systÃ¨mes...', 'info');

                let saveSuccess = false;

                // Essayer tous les systÃ¨mes de sauvegarde
                const saveMethods = [
                    { name: 'claraverseStorageAPI.saveTable', fn: window.claraverseStorageAPI?.saveTable },
                    { name: 'saveTableHTMLNow', fn: window.saveTableHTMLNow },
                    { name: 'claraverseSyncAPI.saveTable', fn: window.claraverseSyncAPI?.saveTable }
                ];

                for (const method of saveMethods) {
                    if (method.fn) {
                        try {
                            const result = method.fn(table);
                            log(`  ${method.name}: ${result ? 'SUCCÃˆS' : 'Ã‰CHEC'}`, result ? 'success' : 'error');
                            if (result) saveSuccess = true;
                        } catch (e) {
                            log(`  ${method.name}: ERREUR (${e.message})`, 'error');
                        }
                    } else {
                        log(`  ${method.name}: NON DISPONIBLE`, 'warning');
                    }
                }

                if (saveSuccess) {
                    log('âœ… Au moins une sauvegarde a rÃ©ussi', 'success');

                    // Simuler un rechargement en modifiant temporairement puis restaurant
                    setTimeout(() => {
                        log('ğŸ”„ Simulation rechargement...', 'info');
                        firstCell.textContent = 'TEMP_SIMULATION_RECHARGEMENT';

                        // Essayer de restaurer
                        setTimeout(() => {
                            if (window.testCorrectionUniverselle) {
                                window.testCorrectionUniverselle();
                            }

                            setTimeout(() => {
                                const finalContent = table.querySelector('td').textContent;
                                log(`ğŸ“‹ Contenu aprÃ¨s simulation: "${finalContent}"`, 'info');

                                if (finalContent === modifiedContent) {
                                    log('âœ… MODIFICATION PERSISTANTE RÃ‰USSIE !', 'success');
                                } else {
                                    log('âŒ MODIFICATION NON PERSISTANTE', 'error');
                                    log(`   Attendu: "${modifiedContent}"`, 'error');
                                    log(`   Obtenu:  "${finalContent}"`, 'error');
                                }
                            }, 200);
                        }, 100);
                    }, 500);
                } else {
                    log('âŒ Aucune sauvegarde n\'a rÃ©ussi', 'error');
                }

            } catch (error) {
                log(`âŒ ERREUR: ${error.message}`, 'error');
            }
        }

        function forceAllSaves() {
            log('ğŸ’¾ === FORÃ‡AGE TOUTES LES SAUVEGARDES ===', 'warning');

            const tables = document.querySelectorAll('table');
            log(`ğŸ“Š ${tables.length} tables trouvÃ©es`, 'info');

            tables.forEach((table, index) => {
                const tableId = table.id || table.getAttribute('data-menu-table-id') || `table_${index}`;
                log(`ğŸ’¾ ForÃ§age sauvegarde table: ${tableId}`, 'info');

                // Essayer tous les systÃ¨mes
                if (window.claraverseStorageAPI) {
                    const result = window.claraverseStorageAPI.saveTable(table);
                    log(`  Nouveau systÃ¨me: ${result ? 'SUCCÃˆS' : 'Ã‰CHEC'}`, result ? 'success' : 'error');
                }

                if (window.saveTableHTMLNow) {
                    const result = window.saveTableHTMLNow(table);
                    log(`  Ancien systÃ¨me: ${result ? 'SUCCÃˆS' : 'Ã‰CHEC'}`, result ? 'success' : 'error');
                }
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            log('ğŸ’¾ Test sauvegarde persistante chargÃ©', 'success');
            log('ğŸ’¡ Modifiez les cellules jaunes et testez la persistance', 'info');

            // Ajouter des listeners sur les cellules Ã©ditables
            const editableCells = document.querySelectorAll('.editable');
            editableCells.forEach((cell, index) => {
                cell.addEventListener('input', function () {
                    log(`âœï¸ Cellule ${index + 1} modifiÃ©e: "${this.textContent}"`, 'warning');

                    // Auto-sauvegarde aprÃ¨s modification
                    setTimeout(() => {
                        const table = this.closest('table');
                        if (table) {
                            log('ğŸ’¾ Auto-sauvegarde aprÃ¨s modification...', 'info');

                            if (window.claraverseStorageAPI) {
                                const result = window.claraverseStorageAPI.saveTable(table);
                                log(`ğŸ’¾ Auto-sauvegarde: ${result ? 'SUCCÃˆS' : 'Ã‰CHEC'}`, result ? 'success' : 'error');
                            }
                        }
                    }, 500);
                });
            });
        });
    </script>
</body>

</html>