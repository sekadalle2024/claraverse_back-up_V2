<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöë R√©cup√©ration d'Urgence - ClaraVerse</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .emergency-header {
            background: linear-gradient(135deg, #dc3545, #bd2130);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }

        .recovery-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .critical-section {
            border-left-color: #dc3545;
            background: #f8f9fa;
        }

        .success-section {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .warning-section {
            border-left-color: #ffc107;
            background: #fffdf5;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        button:hover { background: #0056b3; transform: translateY(-1px); }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }

        .console {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }

        .recovery-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.5s ease;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="emergency-header">
        <h1>üöë Centre de R√©cup√©ration d'Urgence ClaraVerse</h1>
        <p>Diagnostic et r√©paration des donn√©es corrompues</p>
    </div>

    <div class="recovery-section critical-section">
        <h2>ü©∫ Diagnostic Rapide</h2>
        <div id="quick-diagnosis">
            <p></p>‚è≥ Diagnostic en cours...</p>
        </div>
        <button onclick="runQuickDiagnosis()">üîç Diagnostic Complet</button>
    </div>

    <div class="recovery-section">
        <h2>üìä Statistiques de R√©cup√©ration</h2>
        <div class="recovery-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-entries">-</div>
                <div>Entr√©es Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="corrupted-entries">-</div>
                <div>Donn√©es Corrompues</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="healthy-entries">-</div>
                <div>Donn√©es Saines</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recovery-score">-</div>
                <div>Score de Sant√© (%)</div>
            </div>
        </div>
    </div>

    <div class="recovery-section">
        <h2>üîß Actions de R√©cup√©ration</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <button onclick="cleanCorruptedData()" class="btn-warning">üßπ Nettoyer Donn√©es Corrompues</button>
            <button onclick="repairAllData()" class="btn-success">üîß R√©paration Compl√®te</button>
            <button onclick="backupHealthyData()" class="btn-success">üíæ Sauvegarder Donn√©es Saines</button>
            <button onclick="resetAllData()" class="btn-danger" id="reset-btn">üóëÔ∏è Reset Complet (DANGER)</button>
        </div>

        <div class="progress-bar" id="recovery-progress" style="display: none;">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <div id="recovery-status"></div>
    </div>

    <div class="recovery-section">
        <h2>üíª Console de R√©cup√©ration</h2>
        <div class="console" id="recovery-console">üöë Console de r√©cup√©ration initialis√©e - En attente d'analyse...\n</div>
        <button onclick="clearConsole()">üóëÔ∏è Vider Console</button>
        <button onclick="exportLogs()">üì§ Exporter Logs</button>
    </div>

    <div class="recovery-section">
        <h2>üõ°Ô∏è Mesures Pr√©ventives</h2>
        <div class="alert alert-info">
            <strong>Pour √©viter les corruptions futures :</strong>
            <ul>
                <li>Ne pas fermer l'onglet pendant une consolidation</li>
                <li>Attendre la fin des sauvegardes avant actualisation</li>
                <li>Effectuer des sauvegardes r√©guli√®res avec cp.export()</li>
                <li>Surveiller l'indicateur üíæ sur les tables</li>
            </ul>
        </div>
    </div>

    <!-- Chargement des scripts ClaraVerse -->
    <script src="./dev.js"></script>
    <script src="./conso.js"></script>

    <script>
        let recoveryConsole;
        let recoveryLogs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#74c0fc',
                'success': '#40c057',
                'error': '#ff6b6b',
                'warning': '#ffd43b',
                'critical': '#ff0000'
            };

            const logEntry = `${timestamp} - ${message}`;
            recoveryLogs.push({ timestamp, message, type });

            if (recoveryConsole) {
                const color = colors[type] || colors.info;
                recoveryConsole.innerHTML += `<span style="color:${color}">${logEntry}</span>\n`;
                recoveryConsole.scrollTop = recoveryConsole.scrollHeight;
            }

            console.log(`[Recovery] ${logEntry}`);
        }

        function clearConsole() {
            if (recoveryConsole) {
                recoveryConsole.innerHTML = 'üßπ Console vid√©e\n';
                recoveryLogs = [];
            }
        }

        function exportLogs() {
            const logData = {
                timestamp: new Date().toISOString(),
                logs: recoveryLogs,
                systemInfo: getSystemInfo()
            };

            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `claraverse-recovery-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            log('üì§ Logs export√©s avec succ√®s', 'success');
        }

        function getSystemInfo() {
            return {
                userAgent: navigator.userAgent,
                localStorage: {
                    available: typeof(Storage) !== 'undefined',
                    quota: navigator.storage ? 'available' : 'unknown'
                },
                claraverse: {
                    devJS: !!window.cp,
                    consoJS: !!window.claraverseProcessor,
                    syncAPI: !!window.claraverseSyncAPI
                }
            };
        }

        function updateProgress(percentage) {
            const progressBar = document.getElementById('progress-fill');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
        }

        function showProgress() {
            const progressContainer = document.getElementById('recovery-progress');
            if (progressContainer) {
                progressContainer.style.display = 'block';
                updateProgress(0);
            }
        }

        function hideProgress() {
            const progressContainer = document.getElementById('recovery-progress');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
        }

        function runQuickDiagnosis() {
            log('ü©∫ === DIAGNOSTIC RAPIDE D√âMARR√â ===', 'info');

            const diagnosisDiv = document.getElementById('quick-diagnosis');
            let diagnosisHTML = '';
            let issues = [];

            // Test 1: Scripts ClaraVerse
            if (!window.cp) {
                issues.push('Dev.js non charg√©');
                diagnosisHTML += '<p><span class="status-indicator status-error"></span>‚ùå Dev.js non disponible</p>';
                log('‚ùå Dev.js manquant', 'error');
            } else {
                diagnosisHTML += '<p><span class="status-indicator status-ok"></span>‚úÖ Dev.js op√©rationnel</p>';
                log('‚úÖ Dev.js d√©tect√©', 'success');
            }

            if (!window.claraverseProcessor) {
                issues.push('Conso.js non charg√©');
                diagnosisHTML += '<p><span class="status-indicator status-error"></span>‚ùå Conso.js non disponible</p>';
                log('‚ùå Conso.js manquant', 'error');
            } else {
                diagnosisHTML += '<p><span class="status-indicator status-ok"></span>‚úÖ Conso.js op√©rationnel</p>';
                log('‚úÖ Conso.js d√©tect√©', 'success');
            }

            // Test 2: LocalStorage
            try {
                localStorage.setItem('recovery_test', 'test');
                localStorage.removeItem('recovery_test');
                diagnosisHTML += '<p><span class="status-indicator status-ok"></span>‚úÖ LocalStorage accessible</p>';
                log('‚úÖ LocalStorage fonctionnel', 'success');
            } catch (error) {
                issues.push('LocalStorage bloqu√©');
                diagnosisHTML += '<p><span class="status-indicator status-error"></span>‚ùå LocalStorage inaccessible</p>';
                log('‚ùå LocalStorage bloqu√©: ' + error.message, 'error');
            }

            // Analyse des donn√©es
            analyzeStorageData();

            if (issues.length === 0) {
                diagnosisHTML += '<div class="alert alert-success">üéâ Syst√®me en bon √©tat g√©n√©ral</div>';
            } else {
                diagnosisHTML += `<div class="alert alert-danger">‚ö†Ô∏è ${issues.length} probl√®me(s) d√©tect√©(s)</div>`;
            }

            diagnosisDiv.innerHTML = diagnosisHTML;
            log('ü©∫ Diagnostic rapide termin√©', 'info');
        }

        function analyzeStorageData() {
            log('üìä Analyse des donn√©es localStorage...', 'info');

            let totalEntries = 0;
            let corruptedEntries = 0;
            let healthyEntries = 0;

            try {
                // Parcourir toutes les entr√©es ClaraVerse
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('claraverse_cell_') || key.startsWith('claraverse_')) {
                        totalEntries++;

                        try {
                            const data = JSON.parse(localStorage.getItem(key));

                            // V√©rifier corruption
                            if (!data ||
                                data.content === 'undefined' ||
                                data.text === 'undefined' ||
                                data.html === 'undefined' ||
                                (data.content === '' && data.text === '' && data.html === '')) {
                                corruptedEntries++;
                                log(`üîç Donn√©es corrompues d√©tect√©es: ${key}`, 'warning');
                            } else {
                                healthyEntries++;
                            }
                        } catch (parseError) {
                            corruptedEntries++;
                            log(`üîç Erreur parsing: ${key}`, 'warning');
                        }
                    }
                });

                // Mise √† jour des statistiques
                document.getElementById('total-entries').textContent = totalEntries;
                document.getElementById('corrupted-entries').textContent = corruptedEntries;
                document.getElementById('healthy-entries').textContent = healthyEntries;

                const healthScore = totalEntries > 0 ? Math.round((healthyEntries / totalEntries) * 100) : 100;
                document.getElementById('recovery-score').textContent = healthScore;

                // Coloration selon le score
                const scoreElement = document.getElementById('recovery-score');
                if (healthScore >= 90) {
                    scoreElement.style.color = '#28a745';
                } else if (healthScore >= 70) {
                    scoreElement.style.color = '#ffc107';
                } else {
                    scoreElement.style.color = '#dc3545';
                }

                log(`üìä Analyse termin√©e: ${totalEntries} total, ${corruptedEntries} corrompues, ${healthyEntries} saines`, 'info');

            } catch (error) {
                log(`‚ùå Erreur analyse donn√©es: ${error.message}`, 'error');
            }
        }

        function cleanCorruptedData() {
            log('üßπ === NETTOYAGE DES DONN√âES CORROMPUES ===', 'info');
            showProgress();

            let cleanedCount = 0;
            let totalChecked = 0;
            const keysToRemove = [];

            try {
                const keys = Object.keys(localStorage).filter(key =>
                    key.startsWith('claraverse_cell_') || key.startsWith('claraverse_')
                );

                keys.forEach((key, index) => {
                    totalChecked++;
                    updateProgress((index / keys.length) * 100);

                    try {
                        const data = JSON.parse(localStorage.getItem(key));

                        if (!data ||
                            data.content === 'undefined' ||
                            data.text === 'undefined' ||
                            data.html === 'undefined' ||
                            (data.content === '' && data.text === '' && data.html === '')) {
                            keysToRemove.push(key);
                            cleanedCount++;
                            log(`üóëÔ∏è Marqu√© pour suppression: ${key}`, 'warning');
                        }
                    } catch (parseError) {
                        keysToRemove.push(key);
                        cleanedCount++;
                        log(`üóëÔ∏è Donn√©e non parsable supprim√©e: ${key}`, 'warning');
                    }
                });

                // Suppression effective
                keysToRemove.forEach(key => localStorage.removeItem(key));

                updateProgress(100);
                setTimeout(() => hideProgress(), 1000);

                const statusDiv = document.getElementById('recovery-status');
                if (cleanedCount > 0) {
                    statusDiv.innerHTML = `<div class="alert alert-success">‚úÖ Nettoyage termin√©: ${cleanedCount} entr√©es corrompues supprim√©es sur ${totalChecked} v√©rifi√©es</div>`;
                    log(`‚úÖ Nettoyage r√©ussi: ${cleanedCount} entr√©es supprim√©es`, 'success');
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-info">‚ÑπÔ∏è Aucune donn√©e corrompue trouv√©e (${totalChecked} entr√©es v√©rifi√©es)</div>`;
                    log('‚ÑπÔ∏è Aucune corruption d√©tect√©e', 'info');
                }

                // Rafra√Æchir les statistiques
                setTimeout(analyzeStorageData, 500);

            } catch (error) {
                hideProgress();
                const statusDiv = document.getElementById('recovery-status');
                statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Erreur pendant le nettoyage: ${error.message}</div>`;
                log(`‚ùå Erreur nettoyage: ${error.message}`, 'error');
            }
        }

        function repairAllData() {
            log('üîß === R√âPARATION COMPL√àTE D√âMARR√âE ===', 'critical');
            showProgress();

            const steps = [
                'Nettoyage donn√©es corrompues',
                'Scan des tables',
                'Restauration des donn√©es saines',
                'V√©rification finale'
            ];

            let currentStep = 0;

            function executeStep() {
                if (currentStep >= steps.length) {
                    updateProgress(100);
                    setTimeout(() => {
                        hideProgress();
                        const statusDiv = document.getElementById('recovery-status');
                        statusDiv.innerHTML = `<div class="alert alert-success">üéâ R√©paration compl√®te termin√©e avec succ√®s !</div>`;
                        log('üéâ R√©paration compl√®te r√©ussie', 'success');
                        analyzeStorageData();
                    }, 1000);
                    return;
                }

                const step = steps[currentStep];
                log(`üîß √âtape ${currentStep + 1}/${steps.length}: ${step}`, 'info');
                updateProgress((currentStep / steps.length) * 100);

                switch (currentStep) {
                    case 0: // Nettoyage
                        if (window.cp && window.cp.clean) {
                            window.cp.clean();
                        }
                        break;
                    case 1: // Scan
                        if (window.cp && window.cp.scan) {
                            window.cp.scan();
                        }
                        break;
                    case 2: // Restauration
                        if (window.cp && window.cp.repair) {
                            window.cp.repair();
                        }
                        break;
                    case 3: // V√©rification
                        runQuickDiagnosis();
                        break;
                }

                currentStep++;
                setTimeout(executeStep, 1000);
            }

            executeStep();
        }

        function backupHealthyData() {
            log('üíæ Cr√©ation sauvegarde des donn√©es saines...', 'info');

            try {
                const healthyData = {};
                let healthyCount = 0;

                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('claraverse_cell_') || key.startsWith('claraverse_')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));

                            if (data &&
                                data.content !== 'undefined' &&
                                data.text !== 'undefined' &&
                                data.html !== 'undefined' &&
                                !(data.content === '' && data.text === '' && data.html === '')) {
                                healthyData[key] = data;
                                healthyCount++;
                            }
                        } catch (error) {
                            // Ignorer les donn√©es non parsables
                        }
                    }
                });

                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    systemInfo: getSystemInfo(),
                    healthyEntries: healthyCount,
                    data: healthyData
                };

                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `claraverse-backup-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);

                const statusDiv = document.getElementById('recovery-status');
                statusDiv.innerHTML = `<div class="alert alert-success">üíæ Sauvegarde cr√©√©e: ${healthyCount} entr√©es saines export√©es</div>`;
                log(`üíæ Sauvegarde cr√©√©e avec ${healthyCount} entr√©es`, 'success');

            } catch (error) {
                const statusDiv = document.getElementById('recovery-status');
                statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Erreur sauvegarde: ${error.message}</div>`;
                log(`‚ùå Erreur sauvegarde: ${error.message}`, 'error');
            }
        }

        function resetAllData() {
            const confirmed = confirm(
                '‚ö†Ô∏è ATTENTION: Cette action va SUPPRIMER D√âFINITIVEMENT toutes les donn√©es ClaraVerse.\n\n' +
                'Cette action est IRR√âVERSIBLE.\n\n' +
                '√ätes-vous absolument certain de vouloir continuer ?'
            );

            if (!confirmed) {
                log('üö´ Reset annul√© par l\'utilisateur', 'info');
                return;
            }

            const doubleConfirmed = confirm(
                'üö® DERNI√àRE CHANCE üö®\n\n' +
                'Tapez "RESET" dans la console pour confirmer d√©finitivement, ou annulez ici.'
            );

            if (!doubleConfirmed) {
                log('üö´ Reset annul√© au double contr√¥le', 'info');
                return;
            }

            log('üö® === RESET COMPLET EN COURS ===', 'critical');
            showProgress();

            try {
                const keysToRemove = Object.keys(localStorage).filter(key =>
                    key.startsWith('claraverse_') || key.startsWith('claraverse_cell_')
                );

                let removedCount = 0;
                keysToRemove.forEach((key, index) => {
                    localStorage.removeItem(key);
                    removedCount++;
                    updateProgress((index / keysToRemove.length) * 100);
                });

                updateProgress(100);
                setTimeout(() => {
                    hideProgress();
                    const statusDiv = document.getElementById('recovery-status');
                    statusDiv.innerHTML = `<div class="alert alert-warning">üö® Reset complet effectu√©: ${removedCount} entr√©es supprim√©es</div>`;
                    log(`üö® Reset complet: ${removedCount} entr√©es supprim√©es`, 'critical');
                    analyzeStorageData();
                }, 1000);

            } catch (error) {
                hideProgress();
                const statusDiv = document.getElementById('recovery-status');
                statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Erreur pendant le reset: ${error.message}</div>`;
                log(`‚ùå Erreur reset: ${error.message}`, 'error');
            }
        }

        // Initialisation
        function init() {
            recoveryConsole = document.getElementById('recovery-console');
            log('üöë Centre de r√©cup√©ration initialis√©', 'info');

            // Diagnostic automatique au d√©marrage
            setTimeout(() => {
                runQuickDiagnosis();
            }, 1000);

            // S√©curit√© pour le reset
            let resetClicks = 0;
            const resetBtn = document.getElementById('reset-btn');
            resetBtn.addEventListener('click', () => {
                resetClicks++;
                if (resetClicks >= 3) {
                    resetBtn.style.background = '#dc3545';
                    resetBtn.textContent = 'üö® RESET ACTIV√â - DANGER';
                }
            });
        }

        // D√©marrage
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
