<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Simple - Sauvegarde Table Data</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .status {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .status.loading {
      background: #fff3cd;
      color: #856404;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-info { background: #17a2b8; color: white; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border: 1px solid #ddd;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border: 1px solid #ddd;
    }

    th {
      background: #007bff;
      color: white;
      font-weight: 600;
    }

    td[contenteditable="true"] {
      background: #f8f9fa;
      cursor: text;
    }

    td[contenteditable="true"]:hover {
      background: #e9ecef;
    }

    td[contenteditable="true"]:focus {
      outline: 2px solid #007bff;
      background: #fff9e6;
    }

    .console {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .console-entry {
      margin-bottom: 5px;
      padding: 3px 0;
    }

    .console-entry.info { color: #4fc3f7; }
    .console-entry.success { color: #81c784; }
    .console-entry.error { color: #e57373; }
    .console-entry.warning { color: #ffd54f; }

    .instructions {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 3px;
    }

    .instructions h3 {
      color: #1976d2;
      margin-bottom: 10px;
    }

    .instructions ol {
      margin-left: 20px;
    }

    .instructions li {
      margin-bottom: 5px;
    }

    .highlight {
      background: #ffeb3b;
      padding: 2px 4px;
      border-radius: 3px;
    }

    .table-wrapper {
      margin-bottom: 30px;
    }

    .table-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Test Simple - Sauvegarde Table Data</h1>
    <p class="subtitle">Test minimal pour v√©rifier que la sauvegarde fonctionne</p>

    <!-- Status -->
    <div id="status" class="status loading">
      ‚è≥ Chargement du Table Data Manager...
    </div>

    <!-- Instructions -->
    <div class="instructions">
      <h3>üìã Instructions de Test</h3>
      <ol>
        <li>V√©rifier que le status devient <span class="highlight">‚úÖ Pr√™t</span></li>
        <li><strong>Modifier une cellule</strong> dans le tableau ci-dessous</li>
        <li>Cliquer en dehors de la cellule (perdre le focus)</li>
        <li>Cliquer sur <strong>"V√©rifier Sauvegarde"</strong></li>
        <li>Si OK : vous verrez <span class="highlight">‚úÖ La cellule a √©t√© sauvegard√©e</span></li>
      </ol>
    </div>

    <!-- Boutons de Test -->
    <div class="buttons">
      <button class="btn-primary" onclick="testSave()">üß™ V√©rifier Sauvegarde</button>
      <button class="btn-success" onclick="saveAll()">üíæ Sauvegarder Tout</button>
      <button class="btn-info" onclick="showState()">üìä Voir √âtat</button>
      <button class="btn-warning" onclick="runAutoTest()">ü§ñ Test Auto</button>
      <button class="btn-danger" onclick="clearConsole()">üóëÔ∏è Effacer Console</button>
    </div>

    <!-- Table de Test -->
    <div class="table-wrapper">
      <div class="table-info">
        <strong>üìä Table de Test</strong> - Modifiez les cellules ci-dessous
      </div>
      <table class="min-w-full" id="testTable">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Valeur</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td contenteditable="true">Article 1</td>
            <td contenteditable="true">100.00</td>
            <td contenteditable="true">En stock</td>
          </tr>
          <tr>
            <td contenteditable="true">Article 2</td>
            <td contenteditable="true">250.50</td>
            <td contenteditable="true">En commande</td>
          </tr>
          <tr>
            <td contenteditable="true">Article 3</td>
            <td contenteditable="true">75.00</td>
            <td contenteditable="true">Disponible</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Console -->
    <div class="console" id="console">
      <div class="console-entry info">üìã Console de logs - Pr√™t</div>
    </div>
  </div>

  <!-- Charger Table Data Manager -->
  <script src="table_data.js"></script>

  <!-- Script de Test -->
  <script>
    const consoleDiv = document.getElementById('console');
    const statusDiv = document.getElementById('status');

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `console-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      consoleDiv.appendChild(entry);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    function updateStatus(message, type = 'loading') {
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
    }

    function clearConsole() {
      consoleDiv.innerHTML = '<div class="console-entry info">üìã Console effac√©e</div>';
    }

    // Attendre que le manager soit pr√™t
    function waitForManager(callback) {
      if (window.ClaraverseTableDataManager && window.ClaraverseTableData) {
        callback();
      } else {
        setTimeout(() => waitForManager(callback), 100);
      }
    }

    waitForManager(() => {
      updateStatus('‚úÖ Table Data Manager - Pr√™t', 'success');
      log('‚úÖ Table Data Manager charg√©', 'success');
      log('‚úÖ API disponible', 'success');

      // V√©rifier les tables
      const tables = window.ClaraverseTableData.getAllTables();
      log(`üìä ${tables.length} table(s) d√©tect√©e(s)`, 'info');

      // V√©rifier les cellules
      const editableCells = document.querySelectorAll('td[contenteditable="true"]');
      log(`‚úèÔ∏è ${editableCells.length} cellule(s) √©ditable(s)`, 'info');

      // Ajouter des listeners pour logger les modifications
      editableCells.forEach(cell => {
        cell.addEventListener('focus', () => {
          log(`‚úèÔ∏è √âdition cellule [${cell.dataset.rowIndex}, ${cell.dataset.cellIndex}]`, 'info');
        });

        cell.addEventListener('blur', () => {
          log(`üíæ Sauvegarde cellule [${cell.dataset.rowIndex}, ${cell.dataset.cellIndex}]: "${cell.textContent.trim()}"`, 'success');
        });
      });

      log('üéØ Pr√™t pour les tests !', 'success');
    });

    // Test de sauvegarde
    function testSave() {
      log('üß™ Test de sauvegarde...', 'info');

      const cellsWithState = document.querySelectorAll('td[data-cell-state]');

      if (cellsWithState.length === 0) {
        log('‚ùå Aucune cellule n\'a d\'√©tat sauvegard√©', 'error');
        log('‚ö†Ô∏è Modifiez une cellule et perdez le focus d\'abord', 'warning');
        updateStatus('‚ùå Aucune cellule sauvegard√©e', 'error');
        return;
      }

      log(`‚úÖ ${cellsWithState.length} cellule(s) avec √©tat sauvegard√©`, 'success');

      // V√©rifier le premier
      const firstCell = cellsWithState[0];
      try {
        const state = JSON.parse(firstCell.getAttribute('data-cell-state'));
        log(`üìä √âtat de la cellule:`, 'info');
        log(`   - Valeur: "${state.value}"`, 'info');
        log(`   - Timestamp: ${new Date(state.timestamp).toLocaleString()}`, 'info');

        if (state.value === firstCell.textContent.trim()) {
          log('‚úÖ La cellule a √©t√© sauvegard√©e correctement', 'success');
          updateStatus('‚úÖ Sauvegarde fonctionne !', 'success');
        } else {
          log('‚ö†Ô∏è D√©synchronisation d√©tect√©e', 'warning');
          updateStatus('‚ö†Ô∏è D√©synchronisation', 'warning');
        }
      } catch (e) {
        log(`‚ùå Erreur parsing: ${e.message}`, 'error');
        updateStatus('‚ùå Erreur', 'error');
      }
    }

    // Sauvegarder tout
    function saveAll() {
      log('üíæ Sauvegarde de toutes les tables...', 'info');

      if (!window.ClaraverseTableData) {
        log('‚ùå API non disponible', 'error');
        return;
      }

      const tables = document.querySelectorAll('table');
      let count = 0;

      tables.forEach(table => {
        if (window.ClaraverseTableData.saveTable(table)) {
          count++;
        }
      });

      log(`‚úÖ ${count} table(s) sauvegard√©e(s)`, 'success');
      updateStatus('‚úÖ Sauvegarde effectu√©e', 'success');
    }

    // Voir l'√©tat
    function showState() {
      log('üìä √âtat des cellules:', 'info');

      const cells = document.querySelectorAll('td[data-cell-state]');

      if (cells.length === 0) {
        log('‚ÑπÔ∏è Aucune cellule sauvegard√©e', 'info');
        return;
      }

      cells.forEach((cell, index) => {
        try {
          const state = JSON.parse(cell.getAttribute('data-cell-state'));
          log(`  [${cell.dataset.rowIndex}, ${cell.dataset.cellIndex}]: "${state.value}"`, 'info');
        } catch (e) {
          log(`  Erreur cellule ${index}`, 'error');
        }
      });

      log(`üìä Total: ${cells.length} cellule(s)`, 'info');
    }

    // Test automatique
    function runAutoTest() {
      log('ü§ñ D√©marrage du test automatique...', 'info');

      const testCell = document.querySelector('td[contenteditable="true"]');

      if (!testCell) {
        log('‚ùå Aucune cellule √©ditable trouv√©e', 'error');
        return;
      }

      const originalValue = testCell.textContent.trim();
      const testValue = 'TEST_' + Date.now();

      log(`üìù Valeur originale: "${originalValue}"`, 'info');
      log(`üìù Nouvelle valeur: "${testValue}"`, 'info');

      // Modifier
      testCell.textContent = testValue;
      testCell.focus();

      setTimeout(() => {
        testCell.blur();

        setTimeout(() => {
          // V√©rifier
          const state = testCell.getAttribute('data-cell-state');

          if (state) {
            try {
              const parsed = JSON.parse(state);
              if (parsed.value === testValue) {
                log('‚úÖ TEST R√âUSSI : Valeur sauvegard√©e correctement', 'success');
                updateStatus('‚úÖ Test automatique r√©ussi', 'success');
              } else {
                log('‚ùå TEST √âCHOU√â : Valeur incorrecte', 'error');
                log(`   Attendu: "${testValue}"`, 'error');
                log(`   Re√ßu: "${parsed.value}"`, 'error');
                updateStatus('‚ùå Test automatique √©chou√©', 'error');
              }
            } catch (e) {
              log('‚ùå TEST √âCHOU√â : JSON invalide', 'error');
              updateStatus('‚ùå Test automatique √©chou√©', 'error');
            }
          } else {
            log('‚ùå TEST √âCHOU√â : Pas de data-cell-state', 'error');
            updateStatus('‚ùå Test automatique √©chou√©', 'error');
          }

          // Restaurer
          setTimeout(() => {
            testCell.textContent = originalValue;
            testCell.blur();
            log(`üîÑ Valeur restaur√©e: "${originalValue}"`, 'info');
          }, 1000);
        }, 500);
      }, 100);
    }

    // Si le manager n'est pas charg√© apr√®s 5 secondes
    setTimeout(() => {
      if (!window.ClaraverseTableDataManager) {
        updateStatus('‚ùå Table Data Manager non charg√©', 'error');
        log('‚ùå ERREUR: table_data.js n\'a pas √©t√© charg√©', 'error');
        log('‚ö†Ô∏è V√©rifier que table_data.js est dans le m√™me dossier', 'warning');
      }
    }, 5000);
  </script>
</body>
</html>
