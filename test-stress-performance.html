<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests de Stress et Performance</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-size: 12px;
        }
        .test-table th, .test-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }
        .test-table th {
            background-color: #f2f2f2;
        }
        .prose {
            max-width: none;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.warning { background: #ffc107; color: #212529; }
        .test-results {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .stat-box {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Tests de Stress et Performance</h1>
        <p>Tests intensifs pour √©valuer les limites et performances du syst√®me</p>
        
        <div class="warning">
            ‚ö†Ô∏è <strong>ATTENTION:</strong> Ces tests peuvent √™tre intensifs et ralentir temporairement votre navigateur.
            Fermez les autres onglets pour de meilleures performances.
        </div>
        
        <div class="container">
            <h2>üéØ Tests de Performance</h2>
            <button onclick="testMassiveTable()">üìä Table Massive (1000 lignes)</button>
            <button onclick="testRapidCycles()">üîÑ Cycles Rapides (100x)</button>
            <button onclick="testConcurrentTables()">üîÄ Tables Concurrentes</button>
            <button onclick="testMemoryUsage()">üíæ Usage M√©moire</button>
            <button class="warning" onclick="testExtremeStress()">‚ö° Test Extr√™me</button>
            <button class="danger" onclick="clearAllData()">üóëÔ∏è Nettoyer Tout</button>
        </div>

        <div class="container">
            <h2>üìä Statistiques en Temps R√©el</h2>
            <div class="stats">
                <div class="stat-box">
                    <strong>Tables Cr√©√©es</strong><br>
                    <span id="stat-tables">0</span>
                </div>
                <div class="stat-box">
                    <strong>Op√©rations/sec</strong><br>
                    <span id="stat-ops">0</span>
                </div>
                <div class="stat-box">
                    <strong>Temps Moyen</strong><br>
                    <span id="stat-time">0ms</span>
                </div>
                <div class="stat-box">
                    <strong>M√©moire localStorage</strong><br>
                    <span id="stat-storage">0KB</span>
                </div>
            </div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <div class="container">
            <h2>üìã Table de Test Dynamique</h2>
            <div class="prose prose-base dark:prose-invert max-w-none">
                <table id="stress-table" class="test-table min-w-full">
                    <thead id="stress-thead">
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Date</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="stress-tbody">
                        <!-- Sera rempli dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="container">
            <h2>üìä R√©sultats et Logs</h2>
            <div id="test-results" class="test-results">
Tests de stress et performance pr√™ts.
Cliquez sur un bouton pour commencer les tests.

‚ö†Ô∏è Les tests intensifs peuvent prendre du temps et consommer des ressources.
            </div>
        </div>
    </div>

    <!-- Charger le syst√®me de stockage -->
    <script src="menu_storage.js"></script>

    <script>
        let testResults = [];
        let stats = {
            tablesCreated: 0,
            operationsPerSecond: 0,
            averageTime: 0,
            storageUsed: 0
        };

        function log(message) {
            console.log(message);
            testResults.push(`${new Date().toLocaleTimeString()} - ${message}`);
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            document.getElementById('test-results').textContent = testResults.join('\n');
        }

        function updateStats() {
            document.getElementById('stat-tables').textContent = stats.tablesCreated;
            document.getElementById('stat-ops').textContent = stats.operationsPerSecond.toFixed(1);
            document.getElementById('stat-time').textContent = stats.averageTime.toFixed(1) + 'ms';
            document.getElementById('stat-storage').textContent = (stats.storageUsed / 1024).toFixed(1) + 'KB';
        }

        function updateProgress(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        function calculateStorageUsage() {
            let total = 0;
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('claraverse_table_')) {
                    total += localStorage.getItem(key).length;
                }
            });
            return total;
        }

        function generateRandomData(rows) {
            const names = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Henry'];
            const domains = ['example.com', 'test.org', 'demo.net', 'sample.fr'];
            const statuses = ['Actif', 'Inactif', 'Suspendu', 'En attente'];
            
            const data = [];
            for (let i = 0; i < rows; i++) {
                data.push({
                    id: i + 1,
                    name: names[Math.floor(Math.random() * names.length)] + ' ' + (i + 1),
                    email: `user${i + 1}@${domains[Math.floor(Math.random() * domains.length)]}`,
                    date: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                    status: statuses[Math.floor(Math.random() * statuses.length)]
                });
            }
            return data;
        }

        function populateTable(tableId, data) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = tbody.insertRow();
                tr.insertCell(0).textContent = row.id;
                tr.insertCell(1).textContent = row.name;
                tr.insertCell(2).textContent = row.email;
                tr.insertCell(3).textContent = row.date;
                tr.insertCell(4).textContent = row.status;
            });
        }

        async function testMassiveTable() {
            log('‚ö° === TEST: TABLE MASSIVE (1000 LIGNES) ===');
            
            try {
                const table = document.getElementById('stress-table');
                table.removeAttribute('data-robust-table-id');
                
                log('üìä G√©n√©ration de 1000 lignes de donn√©es...');
                const data = generateRandomData(1000);
                
                const startPopulate = performance.now();
                populateTable('stress-tbody', data);
                const endPopulate = performance.now();
                
                log(`üìã Table peupl√©e en ${(endPopulate - startPopulate).toFixed(2)}ms`);
                
                // Test de sauvegarde
                log('üíæ Sauvegarde de la table massive...');
                const startSave = performance.now();
                const saveResult = window.claraverseStorageAPI.saveTable(table);
                const endSave = performance.now();
                const saveTime = endSave - startSave;
                
                log(`üíæ Sauvegarde: ${saveResult ? 'SUCC√àS' : '√âCHEC'} en ${saveTime.toFixed(2)}ms`);
                
                if (saveResult) {
                    // Modifier toutes les cellules
                    const cells = table.querySelectorAll('td');
                    log(`üìù Modification de ${cells.length} cellules...`);
                    
                    const startModify = performance.now();
                    cells.forEach((cell, index) => {
                        cell.textContent = `MODIF_${index}`;
                    });
                    const endModify = performance.now();
                    
                    log(`üìù Modification termin√©e en ${(endModify - startModify).toFixed(2)}ms`);
                    
                    // Test de restauration
                    log('üîÑ Restauration de la table massive...');
                    const startRestore = performance.now();
                    const restoreResult = window.claraverseStorageAPI.restoreTable(table);
                    const endRestore = performance.now();
                    const restoreTime = endRestore - startRestore;
                    
                    log(`üîÑ Restauration: ${restoreResult ? 'SUCC√àS' : '√âCHEC'} en ${restoreTime.toFixed(2)}ms`);
                    
                    // V√©rifier quelques cellules
                    const firstCell = table.querySelector('td');
                    const isCorrect = firstCell && firstCell.textContent === '1';
                    
                    if (isCorrect) {
                        log('‚úÖ Table massive correctement restaur√©e');
                        log(`üìä Performance: Sauvegarde ${saveTime.toFixed(2)}ms, Restauration ${restoreTime.toFixed(2)}ms`);
                    } else {
                        log('‚ùå Probl√®me de restauration de la table massive');
                    }
                    
                    stats.tablesCreated++;
                    stats.averageTime = (saveTime + restoreTime) / 2;
                    stats.storageUsed = calculateStorageUsage();
                    updateStats();
                }
                
            } catch (error) {
                log(`‚ùå ERREUR: ${error.message}`);
            }
        }

        async function testRapidCycles() {
            log('‚ö° === TEST: CYCLES RAPIDES (100x) ===');
            
            try {
                const table = document.getElementById('stress-table');
                table.removeAttribute('data-robust-table-id');
                
                // Cr√©er une petite table pour les tests rapides
                const data = generateRandomData(10);
                populateTable('stress-tbody', data);
                
                const cycles = 100;
                let successCount = 0;
                let totalSaveTime = 0;
                let totalRestoreTime = 0;
                
                log(`üîÑ D√©but de ${cycles} cycles rapides...`);
                
                const overallStart = performance.now();
                
                for (let i = 0; i < cycles; i++) {
                    updateProgress((i / cycles) * 100);
                    
                    // Modifier le contenu
                    const firstCell = table.querySelector('td');
                    const testContent = `CYCLE_${i}_${Date.now()}`;
                    firstCell.textContent = testContent;
                    
                    // Sauvegarder
                    const saveStart = performance.now();
                    const saveResult = window.claraverseStorageAPI.saveTable(table);
                    const saveEnd = performance.now();
                    totalSaveTime += (saveEnd - saveStart);
                    
                    if (saveResult) {
                        // Modifier temporairement
                        firstCell.textContent = 'TEMP';
                        
                        // Restaurer
                        const restoreStart = performance.now();
                        const restoreResult = window.claraverseStorageAPI.restoreTable(table);
                        const restoreEnd = performance.now();
                        totalRestoreTime += (restoreEnd - restoreStart);
                        
                        if (restoreResult && firstCell.textContent === testContent) {
                            successCount++;
                        }
                    }
                    
                    // Petite pause pour √©viter de bloquer l'UI
                    if (i % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 1));
                        log(`üîÑ Cycle ${i + 1}/${cycles} (${successCount} succ√®s)`);
                    }
                }
                
                const overallEnd = performance.now();
                const totalTime = overallEnd - overallStart;
                
                updateProgress(100);
                
                log(`‚úÖ ${successCount}/${cycles} cycles r√©ussis`);
                log(`üìä Temps total: ${totalTime.toFixed(2)}ms`);
                log(`üìä Temps moyen par cycle: ${(totalTime / cycles).toFixed(2)}ms`);
                log(`üìä Sauvegarde moyenne: ${(totalSaveTime / cycles).toFixed(2)}ms`);
                log(`üìä Restauration moyenne: ${(totalRestoreTime / cycles).toFixed(2)}ms`);
                log(`üìä Op√©rations par seconde: ${(cycles * 2 / (totalTime / 1000)).toFixed(1)}`);
                
                stats.operationsPerSecond = cycles * 2 / (totalTime / 1000);
                stats.averageTime = totalTime / cycles;
                stats.storageUsed = calculateStorageUsage();
                updateStats();
                
            } catch (error) {
                log(`‚ùå ERREUR: ${error.message}`);
            }
        }

        async function testConcurrentTables() {
            log('‚ö° === TEST: TABLES CONCURRENTES ===');
            
            try {
                const tableCount = 10;
                const tables = [];
                
                log(`üîÄ Cr√©ation de ${tableCount} tables concurrentes...`);
                
                // Cr√©er plusieurs tables dynamiquement
                const container = document.querySelector('.prose');
                for (let i = 0; i < tableCount; i++) {
                    const table = document.createElement('table');
                    table.id = `concurrent-table-${i}`;
                    table.className = 'test-table min-w-full';
                    table.style.marginBottom = '10px';
                    
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Table ${i}</th>
                                <th>Valeur</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Donn√©es ${i}</td>
                                <td>Valeur ${i}</td>
                            </tr>
                        </tbody>
                    `;
                    
                    container.appendChild(table);
                    tables.push(table);
                }
                
                log(`üìã ${tableCount} tables cr√©√©es`);
                
                // Test de sauvegarde concurrente
                log('üíæ Sauvegarde concurrente...');
                const saveStart = performance.now();
                
                const savePromises = tables.map(async (table, index) => {
                    const cell = table.querySelector('td');
                    cell.textContent = `CONCURRENT_SAVE_${index}_${Date.now()}`;
                    return window.claraverseStorageAPI.saveTable(table);
                });
                
                const saveResults = await Promise.all(savePromises);
                const saveEnd = performance.now();
                
                const successfulSaves = saveResults.filter(result => result).length;
                log(`üíæ ${successfulSaves}/${tableCount} sauvegardes r√©ussies en ${(saveEnd - saveStart).toFixed(2)}ms`);
                
                // Test de restauration concurrente
                log('üîÑ Restauration concurrente...');
                
                // Modifier toutes les tables
                tables.forEach((table, index) => {
                    const cell = table.querySelector('td');
                    cell.textContent = `TEMP_${index}`;
                });
                
                const restoreStart = performance.now();
                const restorePromises = tables.map(table => 
                    window.claraverseStorageAPI.restoreTable(table)
                );
                
                const restoreResults = await Promise.all(restorePromises);
                const restoreEnd = performance.now();
                
                const successfulRestores = restoreResults.filter(result => result).length;
                log(`üîÑ ${successfulRestores}/${tableCount} restaurations r√©ussies en ${(restoreEnd - restoreStart).toFixed(2)}ms`);
                
                // V√©rifier les r√©sultats
                let correctTables = 0;
                tables.forEach((table, index) => {
                    const cell = table.querySelector('td');
                    if (cell.textContent.startsWith(`CONCURRENT_SAVE_${index}`)) {
                        correctTables++;
                    }
                });
                
                log(`‚úÖ ${correctTables}/${tableCount} tables correctement restaur√©es`);
                
                // Nettoyer
                tables.forEach(table => {
                    container.removeChild(table);
                });
                
                stats.tablesCreated += tableCount;
                stats.storageUsed = calculateStorageUsage();
                updateStats();
                
            } catch (error) {
                log(`‚ùå ERREUR: ${error.message}`);
            }
        }

        async function testMemoryUsage() {
            log('‚ö° === TEST: USAGE M√âMOIRE ===');
            
            try {
                const initialStorage = calculateStorageUsage();
                log(`üíæ Stockage initial: ${(initialStorage / 1024).toFixed(1)}KB`);
                
                const table = document.getElementById('stress-table');
                table.removeAttribute('data-robust-table-id');
                
                const testSizes = [10, 50, 100, 500, 1000];
                const results = [];
                
                for (const size of testSizes) {
                    log(`üìä Test avec ${size} lignes...`);
                    
                    const data = generateRandomData(size);
                    populateTable('stress-tbody', data);
                    
                    const beforeSave = calculateStorageUsage();
                    const saveStart = performance.now();
                    const saveResult = window.claraverseStorageAPI.saveTable(table);
                    const saveEnd = performance.now();
                    const afterSave = calculateStorageUsage();
                    
                    if (saveResult) {
                        const storageIncrease = afterSave - beforeSave;
                        const saveTime = saveEnd - saveStart;
                        
                        results.push({
                            size,
                            storageIncrease,
                            saveTime,
                            storagePerRow: storageIncrease / size
                        });
                        
                        log(`  üíæ +${(storageIncrease / 1024).toFixed(1)}KB en ${saveTime.toFixed(2)}ms`);
                        log(`  üìä ${(storageIncrease / size).toFixed(1)} bytes/ligne`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Analyse des r√©sultats
                log('üìä === ANALYSE M√âMOIRE ===');
                results.forEach(result => {
                    log(`${result.size} lignes: ${(result.storageIncrease/1024).toFixed(1)}KB, ${result.saveTime.toFixed(2)}ms, ${result.storagePerRow.toFixed(1)}B/ligne`);
                });
                
                const finalStorage = calculateStorageUsage();
                log(`üíæ Stockage final: ${(finalStorage / 1024).toFixed(1)}KB (+${((finalStorage - initialStorage) / 1024).toFixed(1)}KB)`);
                
                stats.storageUsed = finalStorage;
                updateStats();
                
            } catch (error) {
                log(`‚ùå ERREUR: ${error.message}`);
            }
        }

        async function testExtremeStress() {
            log('‚ö° === TEST EXTR√äME (ATTENTION!) ===');
            
            if (!confirm('Ce test est tr√®s intensif et peut ralentir votre navigateur. Continuer?')) {
                log('‚ùå Test extr√™me annul√© par l\'utilisateur');
                return;
            }
            
            try {
                log('üö® D√âBUT DU TEST EXTR√äME - Pr√©parez-vous!');
                
                const table = document.getElementById('stress-table');
                table.removeAttribute('data-robust-table-id');
                
                // Phase 1: Table √©norme
                log('üìä Phase 1: Cr√©ation d\'une table de 2000 lignes...');
                const hugeData = generateRandomData(2000);
                populateTable('stress-tbody', hugeData);
                
                const phase1Start = performance.now();
                const hugeSave = window.claraverseStorageAPI.saveTable(table);
                const phase1End = performance.now();
                
                log(`üíæ Table √©norme: ${hugeSave ? 'SUCC√àS' : '√âCHEC'} en ${(phase1End - phase1Start).toFixed(2)}ms`);
                
                // Phase 2: Cycles intensifs
                log('üîÑ Phase 2: 200 cycles intensifs...');
                const intenseCycles = 200;
                let intensiveSuccess = 0;
                
                const phase2Start = performance.now();
                
                for (let i = 0; i < intenseCycles; i++) {
                    if (i % 20 === 0) {
                        updateProgress((i / intenseCycles) * 100);
                        log(`üîÑ Cycle intensif ${i}/${intenseCycles}`);
                        await new Promise(resolve => setTimeout(resolve, 1));
                    }
                    
                    const firstCell = table.querySelector('td');
                    firstCell.textContent = `EXTREME_${i}`;
                    
                    const saveResult = window.claraverseStorageAPI.saveTable(table);
                    if (saveResult) {
                        firstCell.textContent = 'TEMP';
                        const restoreResult = window.claraverseStorageAPI.restoreTable(table);
                        if (restoreResult && firstCell.textContent === `EXTREME_${i}`) {
                            intensiveSuccess++;
                        }
                    }
                }
                
                const phase2End = performance.now();
                updateProgress(100);
                
                log(`üîÑ Cycles intensifs: ${intensiveSuccess}/${intenseCycles} succ√®s en ${(phase2End - phase2Start).toFixed(2)}ms`);
                
                // Phase 3: Stress m√©moire
                log('üíæ Phase 3: Test de stress m√©moire...');
                const memoryStressStart = performance.now();
                
                for (let size = 100; size <= 1000; size += 100) {
                    const data = generateRandomData(size);
                    populateTable('stress-tbody', data);
                    window.claraverseStorageAPI.saveTable(table);
                    
                    if (size % 300 === 0) {
                        log(`üíæ Stress m√©moire: ${size} lignes trait√©es`);
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                const memoryStressEnd = performance.now();
                log(`üíæ Stress m√©moire termin√© en ${(memoryStressEnd - memoryStressStart).toFixed(2)}ms`);
                
                // R√©sultats finaux
                const totalTime = memoryStressEnd - phase1Start;
                const finalStorage = calculateStorageUsage();
                
                log('üèÅ === TEST EXTR√äME TERMIN√â ===');
                log(`‚è±Ô∏è Temps total: ${(totalTime / 1000).toFixed(2)} secondes`);
                log(`üíæ Stockage utilis√©: ${(finalStorage / 1024).toFixed(1)}KB`);
                log(`üìä Performance globale: ${intensiveSuccess > intenseCycles * 0.9 ? 'EXCELLENTE' : intensiveSuccess > intenseCycles * 0.7 ? 'BONNE' : 'PROBL√âMATIQUE'}`);
                
                stats.storageUsed = finalStorage;
                stats.operationsPerSecond = (intenseCycles * 2) / (totalTime / 1000);
                updateStats();
                
            } catch (error) {
                log(`‚ùå ERREUR EXTR√äME: ${error.message}`);
            }
        }

        function clearAllData() {
            if (confirm('Supprimer toutes les donn√©es de test? Cette action est irr√©versible.')) {
                const keys = Object.keys(localStorage);
                const claraverseKeys = keys.filter(key => key.startsWith('claraverse_table_'));
                
                claraverseKeys.forEach(key => localStorage.removeItem(key));
                
                log(`üóëÔ∏è ${claraverseKeys.length} entr√©es supprim√©es du localStorage`);
                
                stats.storageUsed = 0;
                updateStats();
                
                // Nettoyer la table
                document.getElementById('stress-tbody').innerHTML = '';
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('‚ö° Tests de stress et performance charg√©s');
            log('‚ö†Ô∏è Ces tests sont intensifs - fermez les autres onglets pour de meilleures performances');
            
            stats.storageUsed = calculateStorageUsage();
            updateStats();
        });
    </script>
</body>
</html>