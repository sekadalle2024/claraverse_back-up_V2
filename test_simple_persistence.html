<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Simple ClaraVerse Persistence</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 20px auto;
        padding: 20px;
        background: #f0f2f5;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 30px;
      }

      .test-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }
      .btn-success {
        background: #10b981;
        color: white;
      }
      .btn-warning {
        background: #f59e0b;
        color: white;
      }
      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .console {
        background: #1a1a1a;
        color: #00ff00;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 20px;
      }

      .console-entry {
        margin: 2px 0;
      }

      .error {
        color: #ff4444;
      }
      .warning {
        color: #ffaa00;
      }
      .success {
        color: #00ff88;
      }
      .info {
        color: #00aaff;
      }

      /* Styles ClaraVerse simulÃ©s */
      .markdown {
        background: white;
        padding: 15px;
        border-radius: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
      }

      table.min-w-full.border.border-gray-200.rounded-lg {
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
      }

      th,
      td {
        border: 1px solid #d1d5db;
        padding: 12px;
        text-align: left;
      }

      th {
        background-color: #f9fafb;
        font-weight: bold;
      }

      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-weight: bold;
      }

      .status.ready {
        background: #dcfce7;
        color: #166534;
      }
      .status.error {
        background: #fecaca;
        color: #991b1b;
      }
      .status.warning {
        background: #fef3c7;
        color: #92400e;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ§ª Test Simple - ClaraVerse Persistence</h1>
      <p>Diagnostic rapide du systÃ¨me de persistance</p>
    </div>

    <div class="test-section">
      <h2>ğŸ›ï¸ ContrÃ´les</h2>
      <div class="controls">
        <button class="btn btn-primary" onclick="testInit()">
          ğŸš€ Test Initialisation
        </button>
        <button class="btn btn-success" onclick="testScan()">
          ğŸ” Test Scan
        </button>
        <button class="btn btn-warning" onclick="testEdit()">
          âœï¸ Test Ã‰dition
        </button>
        <button class="btn btn-danger" onclick="clearTest()">ğŸ—‘ï¸ Vider</button>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="showStatus()">
          ğŸ“Š Status
        </button>
        <button class="btn btn-success" onclick="runAutoTest()">
          ğŸ¤– Test Auto
        </button>
        <button class="btn btn-warning" onclick="clearConsole()">
          ğŸ§¹ Vider Console
        </button>
      </div>
    </div>

    <div class="test-section">
      <h2>ğŸ“Š Console de Test</h2>
      <div id="testConsole" class="console">
        <div class="console-entry info">[INFO] En attente des tests...</div>
      </div>
    </div>

    <div class="test-section">
      <h2>ğŸ“Š Status SystÃ¨me</h2>
      <div id="systemStatus" class="status warning">â³ Non testÃ©</div>
    </div>

    <!-- Tables de Test ClaraVerse -->
    <div class="test-section">
      <h2>ğŸ“‹ Tables de Test</h2>

      <!-- Simulation div response-content-container -->
      <div id="response-content-container">
        <div class="markdown prose prose-base dark:prose-invert max-w-none">
          <h3>Table Test 1 - Pointage</h3>
          <table
            class="min-w-full border border-gray-200 dark:border-gray-700 rounded-lg"
            data-table-id="test_pointage"
          >
            <thead>
              <tr>
                <th>CritÃ¨re</th>
                <th>Ã‰cart</th>
                <th>Conclusion</th>
                <th>CTR 1</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Test A</td>
                <td>0.5</td>
                <td>OK</td>
                <td>85%</td>
              </tr>
              <tr>
                <td>Test B</td>
                <td>1.2</td>
                <td>Ã€ rÃ©viser</td>
                <td>75%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Table de consolidation simulÃ©e -->
      <div class="markdown">
        <h3>Table Test 2 - Consolidation</h3>
        <table class="claraverse-conso-table" data-table-id="test_conso">
          <thead>
            <tr>
              <th style="background: #3b82f6; color: white; padding: 8px">
                ğŸ“Š Table de Consolidation
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="conso-content" style="padding: 8px; background: #f8f9fa">
                â³ En attente de consolidation...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Table simple -->
      <div class="markdown">
        <h3>Table Test 3 - Simple</h3>
        <table class="min-w-full border border-gray-200 rounded-lg">
          <thead>
            <tr>
              <th>Colonne A</th>
              <th>Colonne B</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>DonnÃ©es 1</td>
              <td>DonnÃ©es 2</td>
            </tr>
            <tr>
              <td>Test 1</td>
              <td>Test 2</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Chargement du script -->
    <script src="dev.js"></script>

    <script>
      let testCounter = 0;

      // Fonction de log pour les tests
      function testLog(message, type = "info") {
        const console = document.getElementById("testConsole");
        const entry = document.createElement("div");
        entry.className = `console-entry ${type}`;
        entry.innerHTML = `[${++testCounter}] ${new Date().toLocaleTimeString()} - ${message}`;
        console.appendChild(entry);
        console.scrollTop = console.scrollHeight;

        // Log aussi dans la console navigateur
        console.log(`[TEST] ${message}`);
      }

      function clearConsole() {
        document.getElementById("testConsole").innerHTML = "";
        testCounter = 0;
        testLog("Console vidÃ©e", "info");
      }

      function updateStatus(message, type) {
        const status = document.getElementById("systemStatus");
        status.textContent = message;
        status.className = `status ${type}`;
      }

      // Tests individuels
      function testInit() {
        testLog("ğŸš€ Test d'initialisation...", "info");

        // VÃ©rifier le raccourci principal
        if (typeof window.cp !== "undefined") {
          testLog("âœ… cp (API principale) dÃ©tectÃ©", "success");
          updateStatus("âœ… SystÃ¨me initialisÃ©", "ready");
        } else {
          testLog("âŒ window.cp non trouvÃ©", "error");
          updateStatus("âŒ SystÃ¨me non initialisÃ©", "error");
        }

        // Tester les fonctions de base
        if (typeof window.cp?.scan === "function") {
          testLog("âœ… Fonction cp.scan() disponible", "success");
        } else {
          testLog("âš ï¸ Fonction cp.scan() non disponible", "warning");
        }
      }

      function testScan() {
        testLog("ğŸ” Test de scan des tables...", "info");

        if (typeof window.cp !== "undefined") {
          try {
            window.cp.scan();
            testLog("âœ… Scan exÃ©cutÃ©", "success");

            setTimeout(() => {
              const status = window.cp.status();
              testLog(`ğŸ“Š Tables traitÃ©es: ${status.processedTables}`, "info");
              testLog(`ğŸ“ Cellules Ã©ditables: ${status.editableCells}`, "info");
              testLog(`ğŸ’¾ Cellules stockÃ©es: ${status.storedCells}`, "info");

              if (status.processedTables > 0) {
                updateStatus(
                  `âœ… ${status.processedTables} tables dÃ©tectÃ©es`,
                  "ready",
                );
              } else {
                updateStatus("âš ï¸ Aucune table dÃ©tectÃ©e", "warning");
              }
            }, 1000);
          } catch (error) {
            testLog(`âŒ Erreur lors du scan: ${error}`, "error");
            updateStatus("âŒ Erreur de scan", "error");
          }
        } else {
          testLog("âŒ SystÃ¨me non initialisÃ©", "error");
          updateStatus("âŒ SystÃ¨me non disponible", "error");
        }
      }

      function testEdit() {
        testLog("âœï¸ Test d'Ã©dition...", "info");

        // Chercher une cellule Ã©ditable
        const editableCell = document.querySelector("[data-cell-id]");

        if (editableCell) {
          testLog("âœ… Cellule Ã©ditable trouvÃ©e", "success");

          const originalValue = editableCell.textContent;
          const testValue = `TEST_${Date.now()}`;

          testLog(
            `ğŸ“ Modification: "${originalValue}" â†’ "${testValue}"`,
            "info",
          );

          // Simuler l'Ã©dition
          editableCell.focus();
          editableCell.textContent = testValue;
          editableCell.dispatchEvent(new Event("input", { bubbles: true }));

          testLog("âœ… Modification effectuÃ©e", "success");
          updateStatus("âœ… Test d'Ã©dition rÃ©ussi", "ready");

          // VÃ©rifier la sauvegarde aprÃ¨s 1 seconde
          setTimeout(() => {
            const cellId = editableCell.dataset.cellId;
            const stored = localStorage.getItem(`claraverse_cell_${cellId}`);

            if (stored) {
              testLog("ğŸ’¾ Sauvegarde confirmÃ©e dans localStorage", "success");
              updateStatus("âœ… Persistance confirmÃ©e", "ready");
            } else {
              testLog("âš ï¸ Sauvegarde non confirmÃ©e", "warning");
              updateStatus("âš ï¸ Persistance non confirmÃ©e", "warning");
            }
          }, 1500);
        } else {
          testLog("âŒ Aucune cellule Ã©ditable trouvÃ©e", "error");
          testLog("ğŸ’¡ Lancez d'abord un scan", "info");
          updateStatus("âŒ Aucune cellule Ã©ditable", "error");
        }
      }

      function clearTest() {
        testLog("ğŸ—‘ï¸ Nettoyage des donnÃ©es de test...", "warning");

        if (typeof window.cp !== "undefined") {
          window.cp.clear();
          testLog("âœ… DonnÃ©es supprimÃ©es", "success");
          updateStatus("ğŸ—‘ï¸ DonnÃ©es vidÃ©es", "warning");
        } else {
          // Nettoyage manuel
          Object.keys(localStorage).forEach((key) => {
            if (key.startsWith("claraverse_cell_")) {
              localStorage.removeItem(key);
            }
          });
          testLog("âœ… Nettoyage manuel effectuÃ©", "success");
        }
      }

      function showStatus() {
        testLog("ğŸ“Š Affichage du statut systÃ¨me...", "info");

        if (typeof window.cp !== "undefined") {
          try {
            const status = window.cp.status();
            testLog("=== STATUT SYSTÃˆME ===", "info");
            testLog(`InitialisÃ©: ${status.initialized}`, "info");
            testLog(`Tables traitÃ©es: ${status.processedTables}`, "info");
            testLog(`Cellules Ã©ditables: ${status.editableCells}`, "info");
            testLog(`Cellules stockÃ©es: ${status.storedCells}`, "info");
            testLog(
              `Conteneurs traitÃ©s: ${status.processedContainers}`,
              "info",
            );
            testLog("======================", "info");

            updateStatus(
              `ğŸ“Š ${status.processedTables} tables, ${status.editableCells} cellules`,
              "ready",
            );
          } catch (error) {
            testLog(`âŒ Erreur statut: ${error}`, "error");
          }
        } else {
          testLog("âŒ SystÃ¨me non disponible pour le statut", "error");
        }
      }

      function runAutoTest() {
        testLog("ğŸ¤– Lancement du test automatique...", "info");

        let step = 1;
        const totalSteps = 4;

        function nextStep(fn, delay) {
          setTimeout(() => {
            testLog(`=== Ã‰TAPE ${step}/${totalSteps} ===`, "info");
            fn();
            step++;
          }, delay);
        }

        // SÃ©quence automatique
        nextStep(() => testInit(), 0);
        nextStep(() => testScan(), 2000);
        nextStep(() => testEdit(), 3000);
        nextStep(() => {
          showStatus();
          testLog("ğŸ‰ Test automatique terminÃ© !", "success");
          testLog("ğŸ‘€ VÃ©rifiez que les tables ont des bordures vertes", "info");
          testLog("ğŸ‘€ VÃ©rifiez que vous pouvez Ã©diter les cellules", "info");
        }, 4000);
      }

      // Tests au chargement
      window.addEventListener("load", () => {
        testLog("ğŸŒ Page chargÃ©e", "info");

        // Test d'initialisation automatique aprÃ¨s 2 secondes
        setTimeout(() => {
          testLog("âš¡ Test d'initialisation automatique...", "info");
          testInit();

          // Si tout va bien, lancer le scan
          setTimeout(() => {
            if (typeof window.cp !== "undefined") {
              testLog("ğŸ”„ Lancement du scan automatique...", "info");
              testScan();
            }
          }, 2000);
        }, 2000);
      });

      // Instructions dans la console
      setTimeout(() => {
        console.log(`
ğŸ§ª INSTRUCTIONS DE TEST
=======================

1. Attendez l'initialisation (3-4 secondes)
2. VÃ©rifiez les tables avec OUTLINE VERT
3. VÃ©rifiez les indicateurs ğŸ’¾ sur les tables
4. Cliquez sur cellule â†’ fond jaune
5. Tapez du texte â†’ notification ğŸ’¾
6. Rechargez â†’ donnÃ©es restaurÃ©es âœ¨

ğŸ›ï¸ COMMANDES TEST:
â€¢ testInit() - Test initialisation
â€¢ testScan() - Test scan tables
â€¢ testEdit() - Test Ã©dition auto
â€¢ runAutoTest() - Test complet

ğŸ”§ API SYSTÃˆME:
â€¢ cp.scan() - Scanner maintenant
â€¢ cp.status() - Voir statistiques
â€¢ cp.clear() - Vider donnÃ©es
â€¢ cp.help() - Aide complÃ¨te
â€¢ cp.debug() - Info debug
            `);
      }, 500);
    </script>
  </body>
</html>
