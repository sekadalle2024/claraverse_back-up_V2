<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suite de Tests Compl√®te</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        .test-table th, .test-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .test-table th {
            background-color: #f2f2f2;
        }
        .prose {
            max-width: none;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.danger { background: #dc3545; }
        .test-results {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Suite de Tests Compl√®te</h1>
        <p>Tests complets pour valider toutes les fonctionnalit√©s du syst√®me de stockage de tables</p>
        
        <div class="container">
            <h2>üéØ Tests Principaux</h2>
            <button onclick="runAllTests()">üöÄ Lancer Tous les Tests</button>
            <button onclick="clearResults()">üßπ Effacer R√©sultats</button>
            <button onclick="clearStorage()">üóëÔ∏è Vider localStorage</button>
        </div>

        <div class="test-grid">
            <div class="container">
                <h3>üìã Test 1: Sauvegarde/Restauration Basique</h3>
                <button onclick="testBasicSaveRestore()">Test Basique</button>
                <div class="prose prose-base dark:prose-invert max-w-none">
                    <table id="test-table-1" class="test-table min-w-full">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Age</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Alice</td>
                                <td>25</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="container">
                <h3>üîÑ Test 2: Cycles Multiples</h3>
                <button onclick="testMultipleCycles()">Test Cycles</button>
                <div class="prose prose-base dark:prose-invert max-w-none">
                    <table id="test-table-2" class="test-table min-w-full">
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Prix</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Ordinateur</td>
                                <td>1200‚Ç¨</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="container">
                <h3>üìä Test 3: Table Complexe</h3>
                <button onclick="testComplexTable()">Test Complexe</button>
                <div class="prose prose-base dark:prose-invert max-w-none">
                    <table id="test-table-3" class="test-table min-w-full">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>Jean Dupont</td>
                                <td>jean@example.com</td>
                                <td>Actif</td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>Marie Martin</td>
                                <td>marie@example.com</td>
                                <td>Inactif</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="container">
                <h3>üîÄ Test 4: Tables Multiples</h3>
                <button onclick="testMultipleTables()">Test Multiple</button>
                <div class="prose prose-base dark:prose-invert max-w-none">
                    <table id="test-table-4a" class="test-table min-w-full">
                        <thead>
                            <tr>
                                <th>Table A</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Donn√©es A</td>
                            </tr>
                        </tbody>
                    </table>
                    <br>
                    <table id="test-table-4b" class="test-table min-w-full">
                        <thead>
                            <tr>
                                <th>Table B</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Donn√©es B</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="container">
                <h3>‚ö° Test 5: Performance</h3>
                <button onclick="testPerformance()">Test Performance</button>
                <div class="prose prose-base dark:prose-invert max-w-none">
                    <table id="test-table-5" class="test-table min-w-full">
                        <thead>
                            <tr>
                                <th>Col1</th>
                                <th>Col2</th>
                                <th>Col3</th>
                            </tr>
                        </thead>
                        <tbody id="perf-tbody">
                            <!-- Sera rempli dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="container">
                <h3>üõ°Ô∏è Test 6: Robustesse</h3>
                <button onclick="testRobustness()">Test Robustesse</button>
                <div class="prose prose-base dark:prose-invert max-w-none">
                    <table id="test-table-6" class="test-table min-w-full">
                        <thead>
                            <tr>
                                <th>Test</th>
                                <th>Valeur</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Caract√®res sp√©ciaux: &lt;&gt;&amp;"'</td>
                                <td>√âmojis: üéØüöÄ‚úÖ‚ùå</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="container">
            <h2>üìä R√©sultats des Tests</h2>
            <div id="test-results" class="test-results">
Aucun test ex√©cut√© pour le moment.
Cliquez sur "Lancer Tous les Tests" pour commencer.
            </div>
        </div>
    </div>

    <!-- Charger le syst√®me de stockage -->
    <script src="menu_storage.js"></script>

    <script>
        let testResults = [];

        function log(message) {
            console.log(message);
            testResults.push(`${new Date().toLocaleTimeString()} - ${message}`);
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            document.getElementById('test-results').textContent = testResults.join('\n');
        }

        function clearResults() {
            testResults = [];
            updateResultsDisplay();
        }

        function clearStorage() {
            const keys = Object.keys(localStorage);
            const claraverseKeys = keys.filter(key => key.startsWith('claraverse_table_'));
            claraverseKeys.forEach(key => localStorage.removeItem(key));
            log(`üóëÔ∏è ${claraverseKeys.length} cl√©s de stockage supprim√©es`);
        }

        async function testBasicSaveRestore() {
            log('üß™ === TEST 1: SAUVEGARDE/RESTAURATION BASIQUE ===');
            
            try {
                const table = document.getElementById('test-table-1');
                const firstCell = table.querySelector('td');
                const originalContent = firstCell.textContent;
                const testContent = 'TEST_BASIQUE_' + Date.now();

                // Nettoyer
                table.removeAttribute('data-robust-table-id');
                firstCell.textContent = testContent;
                log(`üìù Contenu d√©fini: "${testContent}"`);

                // Sauvegarder
                const saveResult = window.claraverseStorageAPI.saveTable(table);
                log(`üíæ Sauvegarde: ${saveResult ? 'SUCC√àS' : '√âCHEC'}`);

                // Modifier
                firstCell.textContent = 'CONTENU_TEMPORAIRE';
                log(`üìù Contenu modifi√© temporairement`);

                // Restaurer
                const restoreResult = window.claraverseStorageAPI.restoreTable(table);
                log(`üîÑ Restauration: ${restoreResult ? 'SUCC√àS' : '√âCHEC'}`);

                // V√©rifier
                const finalContent = firstCell.textContent;
                if (finalContent === testContent) {
                    log('‚úÖ TEST 1 R√âUSSI: Contenu correctement restaur√©');
                } else {
                    log(`‚ùå TEST 1 √âCHOU√â: Attendu "${testContent}", obtenu "${finalContent}"`);
                }

                // Restaurer contenu original
                firstCell.textContent = originalContent;

            } catch (error) {
                log(`‚ùå TEST 1 ERREUR: ${error.message}`);
            }
        }

        async function testMultipleCycles() {
            log('üß™ === TEST 2: CYCLES MULTIPLES ===');
            
            try {
                const table = document.getElementById('test-table-2');
                const firstCell = table.querySelector('td');
                const originalContent = firstCell.textContent;
                let successCount = 0;

                table.removeAttribute('data-robust-table-id');

                for (let i = 1; i <= 5; i++) {
                    const testContent = `CYCLE_${i}_${Date.now()}`;
                    
                    firstCell.textContent = testContent;
                    const saveResult = window.claraverseStorageAPI.saveTable(table);
                    
                    firstCell.textContent = 'TEMP';
                    const restoreResult = window.claraverseStorageAPI.restoreTable(table);
                    
                    if (firstCell.textContent === testContent) {
                        successCount++;
                        log(`‚úÖ Cycle ${i}/5 r√©ussi`);
                    } else {
                        log(`‚ùå Cycle ${i}/5 √©chou√©`);
                    }
                }

                if (successCount === 5) {
                    log('‚úÖ TEST 2 R√âUSSI: Tous les cycles fonctionnent');
                } else {
                    log(`‚ùå TEST 2 PARTIELLEMENT R√âUSSI: ${successCount}/5 cycles`);
                }

                firstCell.textContent = originalContent;

            } catch (error) {
                log(`‚ùå TEST 2 ERREUR: ${error.message}`);
            }
        }

        async function testComplexTable() {
            log('üß™ === TEST 3: TABLE COMPLEXE ===');
            
            try {
                const table = document.getElementById('test-table-3');
                const cells = table.querySelectorAll('td');
                const originalContents = Array.from(cells).map(cell => cell.textContent);
                
                table.removeAttribute('data-robust-table-id');

                // Modifier toutes les cellules
                cells.forEach((cell, index) => {
                    cell.textContent = `MODIF_${index}_${Date.now()}`;
                });

                const testContents = Array.from(cells).map(cell => cell.textContent);
                log(`üìù ${cells.length} cellules modifi√©es`);

                // Sauvegarder
                const saveResult = window.claraverseStorageAPI.saveTable(table);
                log(`üíæ Sauvegarde: ${saveResult ? 'SUCC√àS' : '√âCHEC'}`);

                // Modifier temporairement
                cells.forEach(cell => {
                    cell.textContent = 'TEMP';
                });

                // Restaurer
                const restoreResult = window.claraverseStorageAPI.restoreTable(table);
                log(`üîÑ Restauration: ${restoreResult ? 'SUCC√àS' : '√âCHEC'}`);

                // V√©rifier
                let correctCells = 0;
                cells.forEach((cell, index) => {
                    if (cell.textContent === testContents[index]) {
                        correctCells++;
                    }
                });

                if (correctCells === cells.length) {
                    log('‚úÖ TEST 3 R√âUSSI: Toutes les cellules restaur√©es');
                } else {
                    log(`‚ùå TEST 3 PARTIELLEMENT R√âUSSI: ${correctCells}/${cells.length} cellules`);
                }

                // Restaurer contenu original
                cells.forEach((cell, index) => {
                    cell.textContent = originalContents[index];
                });

            } catch (error) {
                log(`‚ùå TEST 3 ERREUR: ${error.message}`);
            }
        }

        async function testMultipleTables() {
            log('üß™ === TEST 4: TABLES MULTIPLES ===');
            
            try {
                const tableA = document.getElementById('test-table-4a');
                const tableB = document.getElementById('test-table-4b');
                const cellA = tableA.querySelector('td');
                const cellB = tableB.querySelector('td');
                
                const originalA = cellA.textContent;
                const originalB = cellB.textContent;
                
                const testContentA = 'TABLE_A_' + Date.now();
                const testContentB = 'TABLE_B_' + Date.now();

                // Nettoyer
                tableA.removeAttribute('data-robust-table-id');
                tableB.removeAttribute('data-robust-table-id');

                // Modifier et sauvegarder les deux tables
                cellA.textContent = testContentA;
                cellB.textContent = testContentB;

                const saveA = window.claraverseStorageAPI.saveTable(tableA);
                const saveB = window.claraverseStorageAPI.saveTable(tableB);
                log(`üíæ Sauvegarde A: ${saveA ? 'SUCC√àS' : '√âCHEC'}, B: ${saveB ? 'SUCC√àS' : '√âCHEC'}`);

                // Modifier temporairement
                cellA.textContent = 'TEMP_A';
                cellB.textContent = 'TEMP_B';

                // Restaurer les deux tables
                const restoreA = window.claraverseStorageAPI.restoreTable(tableA);
                const restoreB = window.claraverseStorageAPI.restoreTable(tableB);
                log(`üîÑ Restauration A: ${restoreA ? 'SUCC√àS' : '√âCHEC'}, B: ${restoreB ? 'SUCC√àS' : '√âCHEC'}`);

                // V√©rifier
                const finalA = cellA.textContent;
                const finalB = cellB.textContent;

                if (finalA === testContentA && finalB === testContentB) {
                    log('‚úÖ TEST 4 R√âUSSI: Les deux tables restaur√©es correctement');
                } else {
                    log(`‚ùå TEST 4 √âCHOU√â: A="${finalA}" (attendu "${testContentA}"), B="${finalB}" (attendu "${testContentB}")`);
                }

                // Restaurer contenu original
                cellA.textContent = originalA;
                cellB.textContent = originalB;

            } catch (error) {
                log(`‚ùå TEST 4 ERREUR: ${error.message}`);
            }
        }

        async function testPerformance() {
            log('üß™ === TEST 5: PERFORMANCE ===');
            
            try {
                const table = document.getElementById('test-table-5');
                const tbody = document.getElementById('perf-tbody');
                
                table.removeAttribute('data-robust-table-id');

                // Cr√©er une grande table
                const rowCount = 100;
                tbody.innerHTML = '';
                for (let i = 0; i < rowCount; i++) {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = `Ligne ${i}`;
                    row.insertCell(1).textContent = `Valeur ${i}`;
                    row.insertCell(2).textContent = `Data ${i}`;
                }

                log(`üìä Table cr√©√©e avec ${rowCount} lignes`);

                // Test de performance sauvegarde
                const startSave = performance.now();
                const saveResult = window.claraverseStorageAPI.saveTable(table);
                const endSave = performance.now();
                const saveTime = endSave - startSave;

                log(`üíæ Sauvegarde: ${saveResult ? 'SUCC√àS' : '√âCHEC'} en ${saveTime.toFixed(2)}ms`);

                // Modifier le contenu
                const cells = table.querySelectorAll('td');
                cells.forEach(cell => {
                    cell.textContent = 'MODIFI√â';
                });

                // Test de performance restauration
                const startRestore = performance.now();
                const restoreResult = window.claraverseStorageAPI.restoreTable(table);
                const endRestore = performance.now();
                const restoreTime = endRestore - startRestore;

                log(`üîÑ Restauration: ${restoreResult ? 'SUCC√àS' : '√âCHEC'} en ${restoreTime.toFixed(2)}ms`);

                // V√©rifier quelques cellules
                const firstCell = table.querySelector('td');
                const isCorrect = firstCell.textContent === 'Ligne 0';

                if (isCorrect && saveTime < 1000 && restoreTime < 1000) {
                    log('‚úÖ TEST 5 R√âUSSI: Performance acceptable');
                } else {
                    log(`‚ùå TEST 5 PROBL√àME: Correct=${isCorrect}, Save=${saveTime.toFixed(2)}ms, Restore=${restoreTime.toFixed(2)}ms`);
                }

            } catch (error) {
                log(`‚ùå TEST 5 ERREUR: ${error.message}`);
            }
        }

        async function testRobustness() {
            log('üß™ === TEST 6: ROBUSTESSE ===');
            
            try {
                const table = document.getElementById('test-table-6');
                const cells = table.querySelectorAll('td');
                
                table.removeAttribute('data-robust-table-id');

                // Contenu avec caract√®res sp√©ciaux
                const specialContent1 = 'Test avec "quotes", <tags>, &amp; caract√®res sp√©ciaux';
                const specialContent2 = '√âmojis: üéØüöÄ‚úÖ‚ùå et accents: √†√©√®√π√ß';

                cells[0].textContent = specialContent1;
                cells[1].textContent = specialContent2;

                log(`üìù Contenu sp√©cial d√©fini`);

                // Sauvegarder
                const saveResult = window.claraverseStorageAPI.saveTable(table);
                log(`üíæ Sauvegarde: ${saveResult ? 'SUCC√àS' : '√âCHEC'}`);

                // Modifier
                cells[0].textContent = 'TEMP1';
                cells[1].textContent = 'TEMP2';

                // Restaurer
                const restoreResult = window.claraverseStorageAPI.restoreTable(table);
                log(`üîÑ Restauration: ${restoreResult ? 'SUCC√àS' : '√âCHEC'}`);

                // V√©rifier
                const final1 = cells[0].textContent;
                const final2 = cells[1].textContent;

                if (final1 === specialContent1 && final2 === specialContent2) {
                    log('‚úÖ TEST 6 R√âUSSI: Caract√®res sp√©ciaux g√©r√©s correctement');
                } else {
                    log(`‚ùå TEST 6 √âCHOU√â: Contenu alt√©r√©`);
                    log(`   Attendu 1: "${specialContent1}"`);
                    log(`   Obtenu 1:  "${final1}"`);
                    log(`   Attendu 2: "${specialContent2}"`);
                    log(`   Obtenu 2:  "${final2}"`);
                }

            } catch (error) {
                log(`‚ùå TEST 6 ERREUR: ${error.message}`);
            }
        }

        async function runAllTests() {
            log('üöÄ === D√âBUT DE LA SUITE DE TESTS COMPL√àTE ===');
            
            const startTime = performance.now();
            
            await testBasicSaveRestore();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            await testMultipleCycles();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            await testComplexTable();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            await testMultipleTables();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            await testPerformance();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            await testRobustness();
            
            const endTime = performance.now();
            const totalTime = endTime - startTime;
            
            log(`üèÅ === SUITE DE TESTS TERMIN√âE en ${totalTime.toFixed(2)}ms ===`);
            
            // Compter les succ√®s
            const successCount = testResults.filter(result => result.includes('R√âUSSI')).length;
            const failCount = testResults.filter(result => result.includes('√âCHOU√â')).length;
            
            log(`üìä R√âSUM√â: ${successCount} succ√®s, ${failCount} √©checs`);
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Suite de tests compl√®te charg√©e');
            log('üí° Cliquez sur "Lancer Tous les Tests" pour commencer');
        });
    </script>
</body>
</html>