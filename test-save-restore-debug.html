<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Debug Sauvegarde/Restauration</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        .test-table th, .test-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .test-table th {
            background-color: #f2f2f2;
        }
        .prose {
            max-width: none;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Debug Sauvegarde/Restauration</h1>
        <p>Test pour identifier les probl√®mes avec la sauvegarde et restauration des tables</p>
        
        <div class="container">
            <h2>üéØ Contr√¥les de Test</h2>
            <button onclick="testBasicSave()">Test Sauvegarde Basique</button>
            <button onclick="testBasicRestore()">Test Restauration Basique</button>
            <button onclick="testFullCycle()">Test Cycle Complet</button>
            <button onclick="testDiagnostics()">Test Diagnostics</button>
            <button onclick="clearLog()">Effacer Log</button>
        </div>

        <div class="container">
            <h2>üìã Table de Test</h2>
            <div class="prose prose-base dark:prose-invert max-w-none">
                <table id="test-table" class="test-table min-w-full">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>√Çge</th>
                            <th>Ville</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Alice</td>
                            <td>25</td>
                            <td>Paris</td>
                        </tr>
                        <tr>
                            <td>Bob</td>
                            <td>30</td>
                            <td>Lyon</td>
                        </tr>
                        <tr>
                            <td>Charlie</td>
                            <td>35</td>
                            <td>Marseille</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="container">
            <h2>üìä Log de Debug</h2>
            <div id="debug-log" class="log">
                Cliquez sur un bouton pour commencer les tests...
            </div>
        </div>

        <div class="container">
            <h2>üíæ √âtat du localStorage</h2>
            <div id="storage-state" class="log">
                √âtat du localStorage appara√Ætra ici...
            </div>
        </div>
    </div>

    <!-- Charger le syst√®me de stockage -->
    <script src="menu_storage.js"></script>

    <script>
        let logDiv = document.getElementById('debug-log');
        let storageDiv = document.getElementById('storage-state');

        // Rediriger console vers l'interface
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function logToInterface(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            let className = '';
            let icon = '';
            
            switch(type) {
                case 'error':
                    className = 'error';
                    icon = '‚ùå';
                    break;
                case 'warn':
                    className = 'warning';
                    icon = '‚ö†Ô∏è';
                    break;
                case 'success':
                    className = 'success';
                    icon = '‚úÖ';
                    break;
                default:
                    icon = '‚ÑπÔ∏è';
            }
            
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${icon} ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = function(...args) {
            const message = args.join(' ');
            logToInterface(message);
            originalConsoleLog.apply(console, args);
        };

        console.error = function(...args) {
            const message = args.join(' ');
            logToInterface(message, 'error');
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            const message = args.join(' ');
            logToInterface(message, 'warn');
            originalConsoleWarn.apply(console, args);
        };

        function updateStorageState() {
            let storageInfo = '√âtat du localStorage:\n\n';
            let tableCount = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('claraverse_table_')) {
                    tableCount++;
                    const value = localStorage.getItem(key);
                    try {
                        const data = JSON.parse(value);
                        storageInfo += `üîë ${key.substring(0, 50)}...\n`;
                        storageInfo += `   üìä Version: ${data.metadata?.version || data.version || '1.0'}\n`;
                        storageInfo += `   üîê Session: ${data.sessionId || 'N/A'}\n`;
                        storageInfo += `   üì¶ Conteneur: ${data.containerId || 'N/A'}\n`;
                        storageInfo += `   üìè Taille: ${value.length} chars\n\n`;
                    } catch (error) {
                        storageInfo += `üîë ${key.substring(0, 50)}... (CORROMPU)\n\n`;
                    }
                }
            }
            
            storageInfo += `\nüìà Total: ${tableCount} table(s) sauvegard√©e(s)`;
            storageDiv.textContent = storageInfo;
        }

        function testBasicSave() {
            logToInterface('üß™ Test Sauvegarde Basique', 'log');
            
            try {
                const table = document.getElementById('test-table');
                if (!table) {
                    logToInterface('‚ùå Table de test non trouv√©e', 'error');
                    return;
                }

                logToInterface('üìã Table trouv√©e, tentative de sauvegarde...', 'log');
                
                // V√©rifier si l'API est disponible
                if (typeof window.claraverseStorageAPI === 'undefined') {
                    logToInterface('‚ùå API claraverseStorageAPI non disponible', 'error');
                    return;
                }

                // Test avec l'API moderne
                const result = window.claraverseStorageAPI.saveTable(table);
                
                if (result) {
                    logToInterface('‚úÖ Sauvegarde r√©ussie avec API moderne', 'success');
                } else {
                    logToInterface('‚ùå √âchec sauvegarde avec API moderne', 'error');
                    
                    // Test avec l'ancienne API
                    if (typeof window.saveTableHTMLNow === 'function') {
                        const legacyResult = window.saveTableHTMLNow(table);
                        if (legacyResult) {
                            logToInterface('‚úÖ Sauvegarde r√©ussie avec API legacy', 'success');
                        } else {
                            logToInterface('‚ùå √âchec sauvegarde avec API legacy', 'error');
                        }
                    } else {
                        logToInterface('‚ùå API legacy non disponible', 'error');
                    }
                }
                
                updateStorageState();
                
            } catch (error) {
                logToInterface(`‚ùå Erreur test sauvegarde: ${error.message}`, 'error');
                console.error('Erreur d√©taill√©e:', error);
            }
        }

        function testBasicRestore() {
            logToInterface('üß™ Test Restauration Basique', 'log');
            
            try {
                const table = document.getElementById('test-table');
                if (!table) {
                    logToInterface('‚ùå Table de test non trouv√©e', 'error');
                    return;
                }

                logToInterface('üìã Table trouv√©e, tentative de restauration...', 'log');
                
                // V√©rifier si l'API est disponible
                if (typeof window.claraverseStorageAPI === 'undefined') {
                    logToInterface('‚ùå API claraverseStorageAPI non disponible', 'error');
                    return;
                }

                // Test avec l'API moderne
                const result = window.claraverseStorageAPI.restoreTable(table);
                
                if (result) {
                    logToInterface('‚úÖ Restauration r√©ussie avec API moderne', 'success');
                } else {
                    logToInterface('‚ö†Ô∏è Aucune donn√©e √† restaurer ou √©chec restauration', 'warn');
                    
                    // Test avec l'ancienne API
                    if (typeof window.restoreTableHTML === 'function') {
                        const legacyResult = window.restoreTableHTML(table);
                        if (legacyResult) {
                            logToInterface('‚úÖ Restauration r√©ussie avec API legacy', 'success');
                        } else {
                            logToInterface('‚ö†Ô∏è Aucune donn√©e legacy √† restaurer', 'warn');
                        }
                    } else {
                        logToInterface('‚ùå API legacy non disponible', 'error');
                    }
                }
                
            } catch (error) {
                logToInterface(`‚ùå Erreur test restauration: ${error.message}`, 'error');
                console.error('Erreur d√©taill√©e:', error);
            }
        }

        function testFullCycle() {
            logToInterface('üß™ Test Cycle Complet (Sauvegarde + Restauration)', 'log');
            
            try {
                const table = document.getElementById('test-table');
                if (!table) {
                    logToInterface('‚ùå Table de test non trouv√©e', 'error');
                    return;
                }

                // Modifier le contenu de la table pour tester
                const originalContent = table.innerHTML;
                const firstCell = table.querySelector('td');
                if (firstCell) {
                    firstCell.textContent = 'TEST_MODIFI√â_' + Date.now();
                    logToInterface('üìù Contenu de table modifi√© pour le test', 'log');
                }

                // √âtape 1: Sauvegarde
                logToInterface('1Ô∏è‚É£ √âtape 1: Sauvegarde...', 'log');
                const saveResult = window.claraverseStorageAPI.saveTable(table);
                
                if (!saveResult) {
                    logToInterface('‚ùå √âchec sauvegarde, arr√™t du test', 'error');
                    return;
                }
                logToInterface('‚úÖ Sauvegarde r√©ussie', 'success');

                // √âtape 2: Modifier le contenu
                logToInterface('2Ô∏è‚É£ √âtape 2: Modification du contenu...', 'log');
                if (firstCell) {
                    firstCell.textContent = 'CONTENU_TEMPORAIRE';
                }

                // √âtape 3: Restauration
                logToInterface('3Ô∏è‚É£ √âtape 3: Restauration...', 'log');
                const restoreResult = window.claraverseStorageAPI.restoreTable(table);
                
                if (restoreResult) {
                    logToInterface('‚úÖ Restauration r√©ussie', 'success');
                    
                    // V√©rifier si le contenu a √©t√© restaur√©
                    const restoredContent = firstCell ? firstCell.textContent : '';
                    if (restoredContent.includes('TEST_MODIFI√â_')) {
                        logToInterface('‚úÖ Contenu correctement restaur√©', 'success');
                    } else {
                        logToInterface('‚ö†Ô∏è Contenu peut-√™tre pas restaur√© correctement', 'warn');
                    }
                } else {
                    logToInterface('‚ùå √âchec restauration', 'error');
                }
                
                updateStorageState();
                
            } catch (error) {
                logToInterface(`‚ùå Erreur test cycle complet: ${error.message}`, 'error');
                console.error('Erreur d√©taill√©e:', error);
            }
        }

        function testDiagnostics() {
            logToInterface('üß™ Test Diagnostics', 'log');
            
            try {
                // Test diagnostics de base
                if (typeof window.claraverseStorageAPI.runDiagnostics === 'function') {
                    logToInterface('üîç Ex√©cution diagnostics de base...', 'log');
                    const diagnostics = window.claraverseStorageAPI.runDiagnostics();
                    logToInterface(`üìä Diagnostics: ${JSON.stringify(diagnostics, null, 2)}`, 'log');
                } else {
                    logToInterface('‚ùå Fonction runDiagnostics non disponible', 'error');
                }

                // Test validation d'int√©grit√©
                if (typeof window.claraverseStorageAPI.validateStorageIntegrity === 'function') {
                    logToInterface('üîç Validation int√©grit√© du stockage...', 'log');
                    const integrity = window.claraverseStorageAPI.validateStorageIntegrity();
                    logToInterface(`üìä Int√©grit√©: Score ${integrity.overall.score}/100`, 'log');
                } else {
                    logToInterface('‚ùå Fonction validateStorageIntegrity non disponible', 'error');
                }

                // Test debug identification
                if (typeof window.claraverseStorageAPI.debugTableIdentification === 'function') {
                    logToInterface('üîç Debug identification de table...', 'log');
                    const table = document.getElementById('test-table');
                    const debug = window.claraverseStorageAPI.debugTableIdentification(table);
                    logToInterface(`üìä Debug: ${debug.allTables.length} table(s) analys√©e(s)`, 'log');
                } else {
                    logToInterface('‚ùå Fonction debugTableIdentification non disponible', 'error');
                }
                
            } catch (error) {
                logToInterface(`‚ùå Erreur test diagnostics: ${error.message}`, 'error');
                console.error('Erreur d√©taill√©e:', error);
            }
        }

        function clearLog() {
            logDiv.innerHTML = 'Log effac√©...\n';
            storageDiv.textContent = '√âtat du localStorage appara√Ætra ici...';
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            logToInterface('üöÄ Interface de test charg√©e', 'log');
            
            // V√©rifier la disponibilit√© des APIs
            setTimeout(() => {
                if (typeof window.claraverseStorageAPI !== 'undefined') {
                    logToInterface('‚úÖ API claraverseStorageAPI disponible', 'success');
                } else {
                    logToInterface('‚ùå API claraverseStorageAPI non disponible', 'error');
                }
                
                if (typeof window.saveTableHTMLNow !== 'undefined') {
                    logToInterface('‚úÖ API legacy saveTableHTMLNow disponible', 'success');
                } else {
                    logToInterface('‚ùå API legacy saveTableHTMLNow non disponible', 'error');
                }
                
                updateStorageState();
            }, 1000);
        });
    </script>
</body>
</html>