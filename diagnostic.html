<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic ClaraVerse - Synchronisation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .diagnostic-box {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-ok { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        .status-warning { color: #ffc107; font-weight: bold; }
        .console-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .section { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>ü©∫ Diagnostic ClaraVerse - Synchronisation Dev.js ‚Üî Conso.js</h1>

    <div class="diagnostic-box">
        <h2>üìã √âtat Actuel</h2>
        <div id="status-report">
            <p>üîç Analyse en cours...</p>
        </div>
        <button onclick="runFullDiagnostic()">üîÑ Actualiser Diagnostic</button>
        <button onclick="clearOutput()">üóëÔ∏è Vider</button>
    </div>

    <div class="diagnostic-box">
        <h2>üîß Actions de Test</h2>
        <button onclick="testDevJS()">Test Dev.js</button>
        <button onclick="testConsoJS()">Test Conso.js</button>
        <button onclick="testSync()">Test Synchronisation</button>
        <button onclick="testTables()">Scan Tables</button>
        <button onclick="testStorage()">Test Storage</button>
    </div>

    <div class="diagnostic-box">
        <h2>üíª Console de Diagnostic</h2>
        <div class="console-output" id="console"></div>
    </div>

    <div class="diagnostic-box">
        <h2>üéØ Table de Test</h2>
        <table class="min-w-full border border-gray-200 dark:border-gray-700 rounded-lg" style="width:100%;border-collapse:collapse;" data-table-id="diagnostic_table">
            <thead>
                <tr style="background:#f8f9fa;">
                    <th style="border:1px solid #dee2e6;padding:8px;">Assertion</th>
                    <th style="border:1px solid #dee2e6;padding:8px;">Ecart</th>
                    <th style="border:1px solid #dee2e6;padding:8px;">CTR1</th>
                    <th style="border:1px solid #dee2e6;padding:8px;">Conclusion</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td contenteditable="true" style="border:1px solid #dee2e6;padding:8px;">Test diagnostic</td>
                    <td contenteditable="true" style="border:1px solid #dee2e6;padding:8px;">100‚Ç¨</td>
                    <td contenteditable="true" style="border:1px solid #dee2e6;padding:8px;">OK</td>
                    <td contenteditable="true" style="border:1px solid #dee2e6;padding:8px;">Valid√©</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Chargement des scripts -->
    <script src="./dev.js"></script>
    <script src="./conso.js"></script>

    <script>
        let consoleElement;
        let statusElement;

        function init() {
            consoleElement = document.getElementById('console');
            statusElement = document.getElementById('status-report');
            log('üöÄ Diagnostic ClaraVerse initialis√©');

            // Diagnostic automatique au d√©marrage
            setTimeout(runFullDiagnostic, 1000);

            // Surveillance continue
            setInterval(runFullDiagnostic, 10000);
        }

        function log(message, type = 'info') {
            if (!consoleElement) return;
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#74c0fc',
                'success': '#00ff00',
                'error': '#ff6b6b',
                'warning': '#ffd43b'
            };
            const color = colors[type] || colors.info;
            consoleElement.innerHTML += `<span style="color:${color}">${timestamp} - ${message}</span>\n`;
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        function clearOutput() {
            if (consoleElement) {
                consoleElement.innerHTML = '';
                log('Console vid√©e');
            }
        }

        function runFullDiagnostic() {
            log('ü©∫ === DIAGNOSTIC COMPLET ===', 'info');

            let statusHTML = '<h3>üìä R√©sum√© du Diagnostic</h3>';
            let issuesFound = [];
            let successCount = 0;
            let totalChecks = 0;

            // 1. Test Dev.js
            totalChecks++;
            if (typeof window.cp !== 'undefined') {
                statusHTML += '<p class="status-ok">‚úÖ Dev.js : Charg√© et API disponible</p>';
                successCount++;
                log('‚úÖ Dev.js d√©tect√© avec API compl√®te', 'success');

                try {
                    const status = window.cp.status();
                    log(`üìä Dev.js Status: ${JSON.stringify(status)}`, 'info');
                } catch (error) {
                    log(`‚ö†Ô∏è Erreur status dev.js: ${error.message}`, 'warning');
                }
            } else {
                statusHTML += '<p class="status-error">‚ùå Dev.js : Non charg√© ou API manquante</p>';
                issuesFound.push('Dev.js non disponible');
                log('‚ùå Dev.js non d√©tect√©', 'error');
            }

            // 2. Test Conso.js
            totalChecks++;
            if (typeof window.claraverseProcessor !== 'undefined') {
                statusHTML += '<p class="status-ok">‚úÖ Conso.js : Charg√© et API disponible</p>';
                successCount++;
                log('‚úÖ Conso.js d√©tect√© avec API', 'success');
            } else {
                statusHTML += '<p class="status-error">‚ùå Conso.js : Non charg√© ou API manquante</p>';
                issuesFound.push('Conso.js non disponible');
                log('‚ùå Conso.js non d√©tect√©', 'error');
            }

            // 3. Test API Sync
            totalChecks++;
            if (typeof window.claraverseSyncAPI !== 'undefined') {
                statusHTML += '<p class="status-ok">‚úÖ API Synchronisation : Disponible</p>';
                successCount++;
                log('‚úÖ API Synchronisation d√©tect√©e', 'success');
            } else {
                statusHTML += '<p class="status-warning">‚ö†Ô∏è API Synchronisation : Non disponible</p>';
                issuesFound.push('API Sync manquante');
                log('‚ö†Ô∏è API Synchronisation non disponible', 'warning');
            }

            // 4. Test LocalStorage
            totalChecks++;
            try {
                localStorage.setItem('diagnostic_test', 'test');
                localStorage.removeItem('diagnostic_test');
                statusHTML += '<p class="status-ok">‚úÖ LocalStorage : Fonctionnel</p>';
                successCount++;
                log('‚úÖ LocalStorage accessible', 'success');
            } catch (error) {
                statusHTML += '<p class="status-error">‚ùå LocalStorage : Erreur d\'acc√®s</p>';
                issuesFound.push('LocalStorage bloqu√©');
                log(`‚ùå LocalStorage: ${error.message}`, 'error');
            }

            // 5. Test Tables
            totalChecks++;
            const tables = document.querySelectorAll('table');
            if (tables.length > 0) {
                statusHTML += `<p class="status-ok">‚úÖ Tables d√©tect√©es : ${tables.length}</p>`;
                successCount++;
                log(`‚úÖ ${tables.length} table(s) d√©tect√©e(s)`, 'success');
            } else {
                statusHTML += '<p class="status-error">‚ùå Aucune table d√©tect√©e</p>';
                issuesFound.push('Aucune table trouv√©e');
                log('‚ùå Aucune table trouv√©e', 'error');
            }

            // 6. Test √âv√©nements
            totalChecks++;
            try {
                const testEvent = new CustomEvent('test:diagnostic', { detail: { test: true } });
                document.dispatchEvent(testEvent);
                statusHTML += '<p class="status-ok">‚úÖ √âv√©nements personnalis√©s : Fonctionnels</p>';
                successCount++;
                log('‚úÖ Syst√®me d\'√©v√©nements op√©rationnel', 'success');
            } catch (error) {
                statusHTML += '<p class="status-error">‚ùå √âv√©nements personnalis√©s : Erreur</p>';
                issuesFound.push('√âv√©nements non support√©s');
                log(`‚ùå √âv√©nements: ${error.message}`, 'error');
            }

            // R√©sum√©
            const successRate = Math.round((successCount / totalChecks) * 100);
            statusHTML += `<hr><p><strong>üìà Score global : ${successCount}/${totalChecks} (${successRate}%)</strong></p>`;

            if (issuesFound.length > 0) {
                statusHTML += '<h4>üö® Probl√®mes d√©tect√©s :</h4><ul>';
                issuesFound.forEach(issue => {
                    statusHTML += `<li>${issue}</li>`;
                });
                statusHTML += '</ul>';
            }

            // Recommandations
            statusHTML += '<h4>üí° Recommandations :</h4><ul>';
            if (!window.cp) {
                statusHTML += '<li>V√©rifiez que dev.js se charge sans erreur (Console F12)</li>';
            }
            if (!window.claraverseProcessor) {
                statusHTML += '<li>V√©rifiez que conso.js se charge sans erreur (Console F12)</li>';
            }
            if (!window.claraverseSyncAPI) {
                statusHTML += '<li>La synchronisation ne sera pas possible sans l\'API</li>';
            }
            if (tables.length === 0) {
                statusHTML += '<li>Testez sur une page contenant des tables ClaraVerse</li>';
            }
            statusHTML += '</ul>';

            statusElement.innerHTML = statusHTML;
            log(`=== DIAGNOSTIC TERMIN√â - Score: ${successRate}% ===`, 'info');
        }

        function testDevJS() {
            log('üîß Test sp√©cifique Dev.js', 'info');
            if (window.cp) {
                try {
                    const result = window.cp.scan();
                    log(`üìä Scan dev.js: ${result} tables`, 'success');

                    const status = window.cp.status();
                    log(`üìã Status: ${status.tables} tables, ${status.editableCells} cellules`, 'info');

                    window.cp.help();
                    log('‚úÖ Dev.js enti√®rement fonctionnel', 'success');
                } catch (error) {
                    log(`‚ùå Erreur dev.js: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå Dev.js non disponible', 'error');
            }
        }

        function testConsoJS() {
            log('üéØ Test sp√©cifique Conso.js', 'info');
            if (window.claraverseProcessor) {
                try {
                    window.claraverseProcessor.processAllTables();
                    log('‚úÖ Conso.js processAllTables() OK', 'success');

                    if (window.claraverseProcessor.getStorageInfo) {
                        const info = window.claraverseProcessor.getStorageInfo();
                        log(`üìä Conso storage: ${JSON.stringify(info)}`, 'info');
                    }
                } catch (error) {
                    log(`‚ùå Erreur conso.js: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå Conso.js non disponible', 'error');
            }
        }

        function testSync() {
            log('üîÑ Test synchronisation', 'info');
            if (window.claraverseSyncAPI) {
                try {
                    // Test notification
                    let eventReceived = false;
                    const handler = (event) => {
                        eventReceived = true;
                        log(`üì° √âv√©nement sync re√ßu: ${event.type}`, 'success');
                    };

                    document.addEventListener('claraverse:table:updated', handler);

                    const table = document.querySelector('table');
                    if (table) {
                        window.claraverseSyncAPI.notifyTableUpdate('test-diagnostic', table, 'diagnostic');
                        log('üì§ Notification envoy√©e', 'info');
                    }

                    setTimeout(() => {
                        document.removeEventListener('claraverse:table:updated', handler);
                        if (eventReceived) {
                            log('‚úÖ Synchronisation fonctionnelle', 'success');
                        } else {
                            log('‚ö†Ô∏è √âv√©nement non re√ßu', 'warning');
                        }
                    }, 1000);

                    // Test sauvegarde
                    window.claraverseSyncAPI.saveAllTables();
                    log('üíæ Sauvegarde forc√©e ex√©cut√©e', 'success');

                } catch (error) {
                    log(`‚ùå Erreur sync: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå API Sync non disponible', 'error');
            }
        }

        function testTables() {
            log('üéØ Test d√©tection tables', 'info');
            const selectors = [
                'table',
                'table.min-w-full',
                'table[data-table-id]',
                '.claraverse-conso-table'
            ];

            selectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                log(`${selector}: ${elements.length} trouv√©(s)`, elements.length > 0 ? 'success' : 'warning');
            });

            // Test cellules √©ditables
            const editableCells = document.querySelectorAll('[contenteditable="true"]');
            log(`Cellules √©ditables: ${editableCells.length}`, 'info');
        }

        function testStorage() {
            log('üíæ Test localStorage d√©taill√©', 'info');
            try {
                // Test √©criture/lecture
                const testKey = 'claraverse_test_' + Date.now();
                const testData = { test: true, timestamp: Date.now() };

                localStorage.setItem(testKey, JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                localStorage.removeItem(testKey);

                if (retrieved.test === testData.test) {
                    log('‚úÖ LocalStorage lecture/√©criture OK', 'success');
                } else {
                    log('‚ùå LocalStorage donn√©es corrompues', 'error');
                }

                // Test cl√©s ClaraVerse
                const claraKeys = Object.keys(localStorage).filter(key =>
                    key.startsWith('claraverse_') || key.startsWith('claraverse_cell_')
                );
                log(`üîë Cl√©s ClaraVerse trouv√©es: ${claraKeys.length}`, 'info');
                if (claraKeys.length > 0) {
                    log(`Exemples: ${claraKeys.slice(0, 3).join(', ')}`, 'info');
                }

            } catch (error) {
                log(`‚ùå Erreur test storage: ${error.message}`, 'error');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', init);

        // Listeners pour √©v√©nements de sync
        document.addEventListener('claraverse:table:updated', (event) => {
            log(`üîî Sync Event: Table Updated (${event.detail.source})`, 'success');
        });

        document.addEventListener('claraverse:consolidation:complete', (event) => {
            log(`üéØ Sync Event: Consolidation Complete`, 'success');
        });

        document.addEventListener('claraverse:table:created', (event) => {
            log(`üÜï Sync Event: Table Created (${event.detail.source})`, 'success');
        });
    </script>
</body>
</html>
