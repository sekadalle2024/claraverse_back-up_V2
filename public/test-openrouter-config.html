<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Configuration OpenRouter</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }

        h2 {
            color: #667eea;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .test-section {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .success {
            color: #28a745;
            font-weight: bold;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .warning {
            color: #ffc107;
            font-weight: bold;
        }

        .info {
            color: #17a2b8;
            font-weight: bold;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .provider-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: border-color 0.3s;
        }

        .provider-card.primary {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .provider-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .badge-primary {
            background: #667eea;
            color: white;
        }

        .badge-enabled {
            background: #28a745;
            color: white;
        }

        .badge-disabled {
            background: #dc3545;
            color: white;
        }

        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
        }

        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-success {
            background: #d4edda;
            color: #155724;
        }

        .log-error {
            background: #f8d7da;
            color: #721c24;
        }

        .log-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .log-warning {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Test Configuration OpenRouter</h1>

        <div class="test-section">
            <p><strong>Objectif:</strong> V√©rifier que OpenRouter est correctement configur√© comme provider par d√©faut
            </p>
            <p><strong>API Key configur√©e:</strong>
                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</p>
        </div>

        <h2>Actions</h2>
        <button onclick="checkIndexedDB()">1. V√©rifier IndexedDB</button>
        <button onclick="testProviderConfig()">2. Tester Configuration</button>
        <button onclick="clearAndReinit()">3. R√©initialiser Providers</button>
        <button onclick="testAPIConnection()">4. Tester Connexion API</button>

        <h2>R√©sultats</h2>
        <div id="results"></div>

        <h2>Logs</h2>
        <div id="logs"></div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');
        const logsDiv = document.getElementById('logs');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.insertBefore(entry, logsDiv.firstChild);
            console.log(message);
        }

        function showResults(html) {
            resultsDiv.innerHTML = html;
        }

        async function checkIndexedDB() {
            log('V√©rification de IndexedDB...', 'info');
            showResults('<p class="info">‚è≥ V√©rification en cours...</p>');

            try {
                const dbRequest = indexedDB.open('clara_db', 1);

                dbRequest.onsuccess = async (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('providers')) {
                        showResults('<p class="error">‚ùå Le store "providers" n\'existe pas dans IndexedDB</p>');
                        log('Store providers non trouv√©', 'error');
                        return;
                    }

                    const transaction = db.transaction(['providers'], 'readonly');
                    const store = transaction.objectStore('providers');
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const providers = request.result;
                        log(`${providers.length} provider(s) trouv√©(s)`, 'success');

                        if (providers.length === 0) {
                            showResults('<p class="warning">‚ö†Ô∏è Aucun provider trouv√©. Cr√©ez un compte ou r√©initialisez les providers.</p>');
                            return;
                        }

                        let html = '<h3>Providers trouv√©s:</h3>';
                        providers.forEach(provider => {
                            const isPrimary = provider.isPrimary ? '<span class="badge badge-primary">PRIMARY</span>' : '';
                            const isEnabled = provider.isEnabled ?
                                '<span class="badge badge-enabled">ENABLED</span>' :
                                '<span class="badge badge-disabled">DISABLED</span>';

                            html += `
                                <div class="provider-card ${provider.isPrimary ? 'primary' : ''}">
                                    <h3>${provider.name} ${isPrimary} ${isEnabled}</h3>
                                    <p><strong>Type:</strong> ${provider.type}</p>
                                    <p><strong>Base URL:</strong> ${provider.baseUrl || 'N/A'}</p>
                                    <p><strong>API Key:</strong> ${provider.apiKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + provider.apiKey.slice(-8) : 'N/A'}</p>
                                    <p><strong>ID:</strong> ${provider.id}</p>
                                </div>
                            `;
                        });

                        const openRouter = providers.find(p => p.type === 'openrouter');
                        if (openRouter) {
                            if (openRouter.isPrimary) {
                                html += '<p class="success">‚úÖ OpenRouter est correctement configur√© comme provider primaire!</p>';
                                log('OpenRouter configur√© correctement', 'success');
                            } else {
                                html += '<p class="warning">‚ö†Ô∏è OpenRouter existe mais n\'est pas le provider primaire</p>';
                                log('OpenRouter n\'est pas primaire', 'warning');
                            }
                        } else {
                            html += '<p class="error">‚ùå OpenRouter n\'est pas configur√©</p>';
                            log('OpenRouter non trouv√©', 'error');
                        }

                        showResults(html);
                    };

                    request.onerror = () => {
                        showResults('<p class="error">‚ùå Erreur lors de la lecture des providers</p>');
                        log('Erreur lecture providers: ' + request.error, 'error');
                    };
                };

                dbRequest.onerror = () => {
                    showResults('<p class="error">‚ùå Impossible d\'ouvrir IndexedDB</p>');
                    log('Erreur ouverture DB: ' + dbRequest.error, 'error');
                };
            } catch (error) {
                showResults(`<p class="error">‚ùå Erreur: ${error.message}</p>`);
                log('Exception: ' + error.message, 'error');
            }
        }

        async function testProviderConfig() {
            log('Test de la configuration...', 'info');
            showResults('<p class="info">‚è≥ Test en cours...</p>');

            try {
                const dbRequest = indexedDB.open('clara_db', 1);

                dbRequest.onsuccess = async (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(['providers'], 'readonly');
                    const store = transaction.objectStore('providers');
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const providers = request.result;
                        const openRouter = providers.find(p => p.type === 'openrouter');

                        let html = '<h3>R√©sultats du test:</h3>';
                        const tests = [];

                        // Test 1: OpenRouter existe
                        if (openRouter) {
                            tests.push({ name: 'OpenRouter existe', status: 'success' });
                            log('‚úì OpenRouter existe', 'success');
                        } else {
                            tests.push({ name: 'OpenRouter existe', status: 'error' });
                            log('‚úó OpenRouter n\'existe pas', 'error');
                        }

                        if (openRouter) {
                            // Test 2: Est primaire
                            if (openRouter.isPrimary) {
                                tests.push({ name: 'Est provider primaire', status: 'success' });
                                log('‚úì OpenRouter est primaire', 'success');
                            } else {
                                tests.push({ name: 'Est provider primaire', status: 'error' });
                                log('‚úó OpenRouter n\'est pas primaire', 'error');
                            }

                            // Test 3: Est activ√©
                            if (openRouter.isEnabled) {
                                tests.push({ name: 'Est activ√©', status: 'success' });
                                log('‚úì OpenRouter est activ√©', 'success');
                            } else {
                                tests.push({ name: 'Est activ√©', status: 'error' });
                                log('‚úó OpenRouter est d√©sactiv√©', 'error');
                            }

                            // Test 4: Base URL correcte
                            if (openRouter.baseUrl === 'https://openrouter.ai/api/v1') {
                                tests.push({ name: 'Base URL correcte', status: 'success' });
                                log('‚úì Base URL correcte', 'success');
                            } else {
                                tests.push({ name: 'Base URL correcte', status: 'error' });
                                log('‚úó Base URL incorrecte: ' + openRouter.baseUrl, 'error');
                            }

                            // Test 5: API Key configur√©e
                            if (openRouter.apiKey && openRouter.apiKey.startsWith('sk-or-v1-')) {
                                tests.push({ name: 'API Key configur√©e', status: 'success' });
                                log('‚úì API Key configur√©e', 'success');
                            } else {
                                tests.push({ name: 'API Key configur√©e', status: 'error' });
                                log('‚úó API Key manquante ou incorrecte', 'error');
                            }
                        }

                        tests.forEach(test => {
                            const icon = test.status === 'success' ? '‚úÖ' : '‚ùå';
                            const className = test.status === 'success' ? 'success' : 'error';
                            html += `<p class="${className}">${icon} ${test.name}</p>`;
                        });

                        const allPassed = tests.every(t => t.status === 'success');
                        if (allPassed) {
                            html += '<h3 class="success">üéâ Tous les tests sont pass√©s!</h3>';
                            log('Tous les tests r√©ussis', 'success');
                        } else {
                            html += '<h3 class="error">‚ùå Certains tests ont √©chou√©</h3>';
                            log('Certains tests ont √©chou√©', 'error');
                        }

                        showResults(html);
                    };
                };
            } catch (error) {
                showResults(`<p class="error">‚ùå Erreur: ${error.message}</p>`);
                log('Exception: ' + error.message, 'error');
            }
        }

        async function clearAndReinit() {
            log('R√©initialisation des providers...', 'warning');

            if (!confirm('‚ö†Ô∏è Cela va supprimer tous les providers existants et les r√©initialiser. Continuer?')) {
                log('R√©initialisation annul√©e', 'info');
                return;
            }

            showResults('<p class="warning">‚è≥ R√©initialisation en cours...</p>');

            try {
                const dbRequest = indexedDB.open('clara_db', 1);

                dbRequest.onsuccess = async (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(['providers'], 'readwrite');
                    const store = transaction.objectStore('providers');

                    // Supprimer tous les providers
                    const clearRequest = store.clear();

                    clearRequest.onsuccess = () => {
                        log('Providers supprim√©s', 'success');
                        showResults(`
                            <p class="success">‚úÖ Providers supprim√©s avec succ√®s</p>
                            <p class="info">‚ÑπÔ∏è Rechargez la page pour que l'application r√©initialise automatiquement les providers par d√©faut</p>
                            <button onclick="location.reload()">Recharger la page</button>
                        `);
                    };

                    clearRequest.onerror = () => {
                        showResults('<p class="error">‚ùå Erreur lors de la suppression</p>');
                        log('Erreur suppression: ' + clearRequest.error, 'error');
                    };
                };
            } catch (error) {
                showResults(`<p class="error">‚ùå Erreur: ${error.message}</p>`);
                log('Exception: ' + error.message, 'error');
            }
        }

        async function testAPIConnection() {
            log('Test de connexion √† l\'API OpenRouter...', 'info');
            showResults('<p class="info">‚è≥ Test de connexion en cours...</p>');

            try {
                const dbRequest = indexedDB.open('clara_db', 1);

                dbRequest.onsuccess = async (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(['providers'], 'readonly');
                    const store = transaction.objectStore('providers');
                    const request = store.getAll();

                    request.onsuccess = async () => {
                        const providers = request.result;
                        const openRouter = providers.find(p => p.type === 'openrouter');

                        if (!openRouter) {
                            showResults('<p class="error">‚ùå OpenRouter n\'est pas configur√©</p>');
                            log('OpenRouter non trouv√©', 'error');
                            return;
                        }

                        try {
                            log('Envoi de requ√™te √† OpenRouter...', 'info');
                            const response = await fetch(`${openRouter.baseUrl}/models`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${openRouter.apiKey}`,
                                    'Content-Type': 'application/json'
                                }
                            });

                            if (response.ok) {
                                const data = await response.json();
                                showResults(`
                                    <p class="success">‚úÖ Connexion r√©ussie √† OpenRouter!</p>
                                    <p class="info">Nombre de mod√®les disponibles: ${data.data ? data.data.length : 'N/A'}</p>
                                    <details>
                                        <summary>Voir la r√©ponse compl√®te</summary>
                                        <pre>${JSON.stringify(data, null, 2)}</pre>
                                    </details>
                                `);
                                log('Connexion API r√©ussie', 'success');
                            } else {
                                const errorText = await response.text();
                                showResults(`
                                    <p class="error">‚ùå Erreur API: ${response.status} ${response.statusText}</p>
                                    <pre>${errorText}</pre>
                                `);
                                log(`Erreur API: ${response.status}`, 'error');
                            }
                        } catch (error) {
                            showResults(`<p class="error">‚ùå Erreur de connexion: ${error.message}</p>`);
                            log('Erreur connexion: ' + error.message, 'error');
                        }
                    };
                };
            } catch (error) {
                showResults(`<p class="error">‚ùå Erreur: ${error.message}</p>`);
                log('Exception: ' + error.message, 'error');
            }
        }

        // Auto-check au chargement
        window.addEventListener('load', () => {
            log('Page charg√©e, pr√™t pour les tests', 'info');
            setTimeout(checkIndexedDB, 500);
        });
    </script>
</body>

</html>