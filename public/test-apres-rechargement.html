<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Test Apr√®s Rechargement</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        h1 {
            color: #4ec9b0;
        }

        .instruction {
            background: #252526;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #007acc;
        }

        .step {
            margin: 10px 0;
            padding: 10px;
            background: #1e1e1e;
        }

        .success {
            color: #4ec9b0;
        }

        .error {
            color: #f48771;
        }

        .warning {
            color: #dcdcaa;
        }

        button {
            padding: 10px 20px;
            background: #0e639c;
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px;
        }

        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>üîç Test Apr√®s Rechargement</h1>

    <div class="instruction">
        <h2>Instructions</h2>
        <ol>
            <li>Ouvrez votre application principale (index.html)</li>
            <li>Modifiez une table via menu.js (supprimez une ligne)</li>
            <li>V√©rifiez dans la console : "‚úÖ Table sauvegard√©e avec succ√®s"</li>
            <li>Rechargez la page (F5)</li>
            <li>Revenez sur cette page</li>
            <li>Cliquez sur "V√©rifier Restauration" ci-dessous</li>
        </ol>
    </div>

    <div class="step">
        <h3>√âtape 1: V√©rifier Session</h3>
        <button onclick="checkSession()">V√©rifier Session</button>
        <pre id="session-result"></pre>
    </div>

    <div class="step">
        <h3>√âtape 2: V√©rifier IndexedDB</h3>
        <button onclick="checkIndexedDB()">V√©rifier IndexedDB</button>
        <pre id="indexeddb-result"></pre>
    </div>

    <div class="step">
        <h3>√âtape 3: Comparer Avant/Apr√®s</h3>
        <p class="warning">Cette √©tape n√©cessite que vous ayez not√© le nombre de lignes AVANT rechargement</p>
        <button onclick="compareData()">Comparer</button>
        <pre id="compare-result"></pre>
    </div>

    <script>
        function log(id, msg, type = 'info') {
            const el = document.getElementById(id);
            const span = document.createElement('div');
            span.className = type;
            span.textContent = msg;
            el.appendChild(span);
        }

        window.checkSession = () => {
            const result = document.getElementById('session-result');
            result.innerHTML = '';

            const session = sessionStorage.getItem('claraverse_stable_session');
            if (session) {
                log('session-result', `‚úÖ Session trouv√©e: ${session}`, 'success');
                log('session-result', `   Cr√©√©e le: ${new Date(parseInt(session.split('_')[2])).toLocaleString()}`, 'info');
            } else {
                log('session-result', '‚ùå Aucune session stable trouv√©e', 'error');
                log('session-result', '   ‚Üí Cr√©ez une table d\'abord dans l\'application', 'warning');
            }
        };

        window.checkIndexedDB = async () => {
            const result = document.getElementById('indexeddb-result');
            result.innerHTML = '';

            try {
                const session = sessionStorage.getItem('claraverse_stable_session');
                if (!session) {
                    log('indexeddb-result', '‚ùå Pas de session', 'error');
                    return;
                }

                log('indexeddb-result', 'üîç Ouverture IndexedDB...', 'info');

                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('clara_db', 12);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                log('indexeddb-result', '‚úÖ IndexedDB ouverte', 'success');

                const tables = await new Promise((resolve, reject) => {
                    const tx = db.transaction('clara_generated_tables', 'readonly');
                    const store = tx.objectStore('clara_generated_tables');
                    const index = store.index('sessionId');
                    const request = index.getAll(session);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                log('indexeddb-result', `üìä ${tables.length} table(s) trouv√©e(s)`, 'success');

                tables.forEach((table, i) => {
                    const div = document.createElement('div');
                    div.innerHTML = table.tableHTML;
                    const rows = div.querySelectorAll('tbody tr').length;

                    log('indexeddb-result', `\n  Table ${i + 1}:`, 'info');
                    log('indexeddb-result', `    ID: ${table.id}`, 'info');
                    log('indexeddb-result', `    Keyword: ${table.keyword}`, 'info');
                    log('indexeddb-result', `    Lignes: ${rows}`, 'success');
                    log('indexeddb-result', `    Sauvegard√©e: ${new Date(table.timestamp).toLocaleString()}`, 'info');
                    log('indexeddb-result', `    Fingerprint: ${table.fingerprint.substring(0, 8)}...`, 'info');
                });

                if (tables.length > 0) {
                    log('indexeddb-result', '\n‚úÖ Les tables SONT dans IndexedDB', 'success');
                    log('indexeddb-result', '   ‚Üí Si elles n\'apparaissent pas dans l\'app, c\'est un probl√®me de RESTAURATION', 'warning');
                } else {
                    log('indexeddb-result', '\n‚ùå Aucune table sauvegard√©e', 'error');
                    log('indexeddb-result', '   ‚Üí Le probl√®me est dans la SAUVEGARDE', 'warning');
                }

            } catch (error) {
                log('indexeddb-result', `‚ùå Erreur: ${error.message}`, 'error');
                console.error(error);
            }
        };

        window.compareData = async () => {
            const result = document.getElementById('compare-result');
            result.innerHTML = '';

            const rowsBefore = prompt('Combien de lignes AVANT la suppression ?', '3');
            if (!rowsBefore) return;

            try {
                const session = sessionStorage.getItem('claraverse_stable_session');
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('clara_db', 12);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                const tables = await new Promise((resolve, reject) => {
                    const tx = db.transaction('clara_generated_tables', 'readonly');
                    const store = tx.objectStore('clara_generated_tables');
                    const index = store.index('sessionId');
                    const request = index.getAll(session);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                if (tables.length === 0) {
                    log('compare-result', '‚ùå Aucune table trouv√©e', 'error');
                    return;
                }

                const div = document.createElement('div');
                div.innerHTML = tables[0].tableHTML;
                const rowsAfter = div.querySelectorAll('tbody tr').length;

                log('compare-result', `üìä Avant: ${rowsBefore} lignes`, 'info');
                log('compare-result', `üìä Apr√®s: ${rowsAfter} lignes`, 'info');
                log('compare-result', `üìä Diff√©rence: ${rowsBefore - rowsAfter} ligne(s)`, 'info');

                if (rowsAfter < rowsBefore) {
                    log('compare-result', '\n‚úÖ LA MODIFICATION EST SAUVEGARD√âE !', 'success');
                    log('compare-result', '   ‚Üí Si elle n\'appara√Æt pas dans l\'app, le probl√®me est la RESTAURATION', 'warning');
                } else if (rowsAfter == rowsBefore) {
                    log('compare-result', '\n‚ùå LA MODIFICATION N\'EST PAS SAUVEGARD√âE', 'error');
                    log('compare-result', '   ‚Üí Le probl√®me est dans la SAUVEGARDE', 'warning');
                } else {
                    log('compare-result', '\n‚ö†Ô∏è Donn√©es incoh√©rentes', 'warning');
                }

            } catch (error) {
                log('compare-result', `‚ùå Erreur: ${error.message}`, 'error');
            }
        };

        // Auto-check au chargement
        setTimeout(() => {
            checkSession();
            checkIndexedDB();
        }, 500);
    </script>
</body>

</html>