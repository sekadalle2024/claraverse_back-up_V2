<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Persistance Checkboxes CIA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #007bff;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }

        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 20px 0;
        }

        .instructions h3 {
            margin-top: 0;
            color: #007bff;
        }

        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:hover {
            background: #e9ecef;
        }

        .button-group {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        }

        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status-info {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            color: #0c5460;
        }

        .status-success {
            background: #d4edda;
            border-left: 4px solid #155724;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border-left: 4px solid #721c24;
            color: #721c24;
        }

        #console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Test de Persistance des Checkboxes CIA</h1>

        <div class="instructions">
            <h3>üìã Instructions de Test</h3>
            <ol>
                <li><strong>√âtape 1:</strong> Cliquez sur "Charger conso.js" pour initialiser le syst√®me</li>
                <li><strong>√âtape 2:</strong> Cochez une ou plusieurs checkboxes dans la table ci-dessous</li>
                <li><strong>√âtape 3:</strong> Cliquez sur "V√©rifier Sauvegarde" pour voir si les donn√©es sont dans
                    localStorage</li>
                <li><strong>√âtape 4:</strong> Rechargez la page (F5) et v√©rifiez si les checkboxes sont toujours coch√©es
                </li>
                <li><strong>√âtape 5:</strong> Si les checkboxes ne persistent pas, cliquez sur "Diagnostic Complet"</li>
            </ol>
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="loadConsoScript()">üì• Charger conso.js</button>
            <button class="btn-success" onclick="checkStorage()">üíæ V√©rifier Sauvegarde</button>
            <button class="btn-warning" onclick="runDiagnostic()">üîç Diagnostic Complet</button>
            <button class="btn-danger" onclick="clearStorage()">üóëÔ∏è Vider localStorage</button>
            <button class="btn-primary" onclick="forceRestore()">üîÑ Forcer Restauration</button>
        </div>

        <div id="status" class="status status-info">
            ‚ÑπÔ∏è Cliquez sur "Charger conso.js" pour commencer
        </div>

        <h2>üìä Table d'Examen CIA (Test)</h2>
        <table id="test-table">
            <thead>
                <tr>
                    <th>Question</th>
                    <th>R√©ponse A</th>
                    <th>R√©ponse B</th>
                    <th>R√©ponse C</th>
                    <th>Reponse_user</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Question 1: Quelle est la d√©finition de l'audit interne?</td>
                    <td>Une activit√© de conseil</td>
                    <td>Une activit√© d'assurance et de conseil</td>
                    <td>Une activit√© de contr√¥le</td>
                    <td></td>
                </tr>
                <tr>
                    <td>Question 2: Quel est le r√¥le du CAE?</td>
                    <td>Superviser l'√©quipe</td>
                    <td>Diriger l'audit interne</td>
                    <td>Contr√¥ler les finances</td>
                    <td></td>
                </tr>
                <tr>
                    <td>Question 3: Qu'est-ce que le COSO?</td>
                    <td>Un framework de contr√¥le interne</td>
                    <td>Un logiciel d'audit</td>
                    <td>Une certification</td>
                    <td></td>
                </tr>
                <tr>
                    <td>Question 4: Quelle est la fr√©quence des audits?</td>
                    <td>Mensuelle</td>
                    <td>Trimestrielle</td>
                    <td>Selon le plan d'audit</td>
                    <td></td>
                </tr>
                <tr>
                    <td>Question 5: Qu'est-ce qu'un risque r√©siduel?</td>
                    <td>Le risque apr√®s contr√¥les</td>
                    <td>Le risque initial</td>
                    <td>Le risque acceptable</td>
                    <td></td>
                </tr>
            </tbody>
        </table>

        <h3>üì∫ Console de Diagnostic</h3>
        <div id="console-output">Aucun diagnostic ex√©cut√©...</div>
    </div>

    <script>
        let consoLoaded = false;
        let diagnosticLoaded = false;

        // Rediriger console.log vers notre div
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const consoleOutput = document.getElementById('console-output');

        function appendToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üìù';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function (...args) {
            originalLog.apply(console, args);
            appendToConsole(args.join(' '), 'log');
        };

        console.error = function (...args) {
            originalError.apply(console, args);
            appendToConsole(args.join(' '), 'error');
        };

        console.warn = function (...args) {
            originalWarn.apply(console, args);
            appendToConsole(args.join(' '), 'warn');
        };

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status status-${type}`;
            statusDiv.textContent = message;
        }

        function loadConsoScript() {
            if (consoLoaded) {
                updateStatus('‚ö†Ô∏è conso.js est d√©j√† charg√©', 'warning');
                return;
            }

            updateStatus('‚è≥ Chargement de conso.js...', 'info');
            consoleOutput.textContent = '';
            console.log('üöÄ D√©but du chargement de conso.js');

            const script = document.createElement('script');
            script.src = './conso.js';
            script.onload = function () {
                consoLoaded = true;
                console.log('‚úÖ conso.js charg√© avec succ√®s');
                updateStatus('‚úÖ conso.js charg√©! Attendez 2 secondes que les tables soient trait√©es...', 'success');

                setTimeout(() => {
                    checkTableProcessing();
                }, 2000);
            };
            script.onerror = function () {
                console.error('‚ùå Erreur de chargement de conso.js');
                updateStatus('‚ùå Erreur: Impossible de charger conso.js', 'error');
            };
            document.head.appendChild(script);
        }

        function checkTableProcessing() {
            const table = document.getElementById('test-table');
            const hasId = !!table.dataset.tableId;
            const hasCheckboxes = table.querySelectorAll('input[type="checkbox"]').length > 0;

            console.log(`üìä V√©rification de la table:`);
            console.log(`  - ID assign√©: ${hasId ? '‚úÖ ' + table.dataset.tableId : '‚ùå Non'}`);
            console.log(`  - Checkboxes cr√©√©es: ${hasCheckboxes ? '‚úÖ Oui' : '‚ùå Non'}`);

            if (hasId && hasCheckboxes) {
                updateStatus('‚úÖ Table trait√©e! Vous pouvez maintenant cocher des checkboxes', 'success');
            } else {
                updateStatus('‚ö†Ô∏è Table non trait√©e correctement. V√©rifiez la console', 'warning');
            }
        }

        function checkStorage() {
            console.log('\nüîç V√âRIFICATION DU LOCALSTORAGE');
            console.log('='.repeat(60));

            try {
                const storageKey = 'claraverse_tables_data';
                const rawData = localStorage.getItem(storageKey);

                if (!rawData) {
                    console.error('‚ùå Aucune donn√©e dans localStorage');
                    updateStatus('‚ùå Aucune donn√©e sauvegard√©e dans localStorage', 'error');
                    return;
                }

                const data = JSON.parse(rawData);
                const tableCount = Object.keys(data).length;
                console.log(`‚úÖ ${tableCount} table(s) trouv√©e(s)`);

                Object.keys(data).forEach(id => {
                    const tableData = data[id];
                    const checkboxCells = tableData.cells ? tableData.cells.filter(c => c.isCheckboxCell) : [];
                    const checkedCells = checkboxCells.filter(c => c.isChecked);

                    console.log(`\nüìã Table: ${id}`);
                    console.log(`  - Headers: ${tableData.headers ? tableData.headers.join(', ') : 'N/A'}`);
                    console.log(`  - Cellules avec checkbox: ${checkboxCells.length}`);
                    console.log(`  - Checkboxes coch√©es: ${checkedCells.length}`);

                    if (checkedCells.length > 0) {
                        console.log(`  - D√©tails des checkboxes coch√©es:`);
                        checkedCells.forEach((cell, i) => {
                            console.log(`    ‚Ä¢ Checkbox ${i + 1}: ligne ${cell.row}, col ${cell.col}`);
                        });
                    }
                });

                updateStatus(`‚úÖ ${tableCount} table(s) sauvegard√©e(s) dans localStorage`, 'success');
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                updateStatus('‚ùå Erreur lors de la lecture du localStorage', 'error');
            }
        }

        function runDiagnostic() {
            if (diagnosticLoaded) {
                console.log('\nüîÑ Ex√©cution du diagnostic...\n');
                // Le script de diagnostic s'ex√©cute automatiquement
                return;
            }

            console.log('üì• Chargement du script de diagnostic...');
            const script = document.createElement('script');
            script.src = 'diagnostic-checkboxes-cia-persistance.js';
            script.onload = function () {
                diagnosticLoaded = true;
                console.log('‚úÖ Diagnostic charg√© et ex√©cut√©');
                updateStatus('‚úÖ Diagnostic ex√©cut√©. Consultez la console ci-dessus', 'success');
            };
            script.onerror = function () {
                console.error('‚ùå Erreur de chargement du diagnostic');
                updateStatus('‚ùå Erreur: Impossible de charger le diagnostic', 'error');
            };
            document.head.appendChild(script);
        }

        function clearStorage() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir vider le localStorage?\n\nToutes les donn√©es sauvegard√©es seront perdues.')) {
                localStorage.removeItem('claraverse_tables_data');
                console.log('üóëÔ∏è localStorage vid√©');
                updateStatus('‚úÖ localStorage vid√©', 'success');
            }
        }

        function forceRestore() {
            if (!consoLoaded) {
                updateStatus('‚ö†Ô∏è Chargez d\'abord conso.js', 'warning');
                return;
            }

            console.log('\nüîÑ FOR√áAGE DE LA RESTAURATION');
            console.log('='.repeat(60));

            const table = document.getElementById('test-table');

            if (window.claraverseProcessor) {
                try {
                    const restored = window.claraverseProcessor.restoreTableData(table);
                    if (restored) {
                        console.log('‚úÖ Table restaur√©e avec succ√®s');
                        updateStatus('‚úÖ Table restaur√©e!', 'success');
                    } else {
                        console.warn('‚ö†Ô∏è Aucune donn√©e √† restaurer');
                        updateStatus('‚ö†Ô∏è Aucune donn√©e √† restaurer', 'warning');
                    }
                } catch (error) {
                    console.error('‚ùå Erreur:', error);
                    updateStatus('‚ùå Erreur lors de la restauration', 'error');
                }
            } else {
                console.error('‚ùå Processeur Claraverse non trouv√©');
                updateStatus('‚ùå Processeur non trouv√©', 'error');
            }
        }

        // V√©rifier au chargement si des donn√©es existent
        window.addEventListener('load', function () {
            const storageKey = 'claraverse_tables_data';
            const rawData = localStorage.getItem(storageKey);

            if (rawData) {
                try {
                    const data = JSON.parse(rawData);
                    const tableCount = Object.keys(data).length;
                    console.log(`‚ÑπÔ∏è ${tableCount} table(s) trouv√©e(s) dans localStorage au chargement`);
                } catch (e) {
                    console.error('‚ùå Erreur lecture localStorage:', e);
                }
            } else {
                console.log('‚ÑπÔ∏è Aucune donn√©e dans localStorage au chargement');
            }
        });
    </script>
</body>

</html>