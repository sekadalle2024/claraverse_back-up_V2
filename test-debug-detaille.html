<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug D√©taill√©</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        .test-table th, .test-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .test-table th {
            background-color: #f2f2f2;
        }
        .prose {
            max-width: none;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug D√©taill√©</h1>
        <p>Analyse compl√®te du probl√®me de restauration</p>
        
        <div class="container">
            <h2>üéØ Tests</h2>
            <button onclick="debugComplete()">Debug Complet</button>
            <button onclick="clearLog()">Effacer Log</button>
        </div>

        <div class="container">
            <h2>üìã Table de Test</h2>
            <div class="prose prose-base dark:prose-invert max-w-none">
                <table id="test-table" class="test-table min-w-full">
                    <thead>
                        <tr>
                            <th>Test</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Original</td>
                            <td>Data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="container">
            <h2>üìä Log de Debug</h2>
            <div id="test-log" class="log">
                Cliquez sur Debug Complet pour analyser...
            </div>
        </div>
    </div>

    <!-- Charger le syst√®me de stockage -->
    <script src="menu_storage.js"></script>

    <script>
        let logDiv = document.getElementById('test-log');

        function logMessage(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            let className = '';
            let icon = '';
            
            switch(type) {
                case 'error':
                    className = 'error';
                    icon = '‚ùå';
                    break;
                case 'warn':
                    className = 'warning';
                    icon = '‚ö†Ô∏è';
                    break;
                case 'success':
                    className = 'success';
                    icon = '‚úÖ';
                    break;
                default:
                    icon = '‚ÑπÔ∏è';
            }
            
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${icon} ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function debugComplete() {
            logMessage('üîç === DEBUG COMPLET ===', 'log');
            
            try {
                const table = document.getElementById('test-table');
                if (!table) {
                    logMessage('‚ùå Table non trouv√©e', 'error');
                    return;
                }

                const firstCell = table.querySelector('td');
                const testContent = 'CONTENU_DEBUG_TEST';

                // === PHASE 1: PR√âPARATION ===
                logMessage('üìã PHASE 1: PR√âPARATION', 'log');
                
                // Nettoyer les attributs
                table.removeAttribute('data-robust-table-id');
                table.removeAttribute('data-menu-table-id');
                logMessage('üßπ Attributs nettoy√©s', 'log');

                // D√©finir le contenu de test
                if (firstCell) {
                    firstCell.textContent = testContent;
                }
                logMessage(`üìù Contenu d√©fini: "${testContent}"`, 'log');

                // === PHASE 2: G√âN√âRATION D'ID ===
                logMessage('üìã PHASE 2: G√âN√âRATION D\'ID', 'log');
                
                const generatedId = window.claraverseStorageAPI.generateRobustTableId(table);
                logMessage(`üîë ID g√©n√©r√©: ${generatedId}`, 'log');

                const storedIdAfterGeneration = table.getAttribute('data-robust-table-id');
                logMessage(`üîë ID stock√© sur table apr√®s g√©n√©ration: ${storedIdAfterGeneration}`, 'log');

                // === PHASE 3: SAUVEGARDE ===
                logMessage('üìã PHASE 3: SAUVEGARDE', 'log');
                
                const saveResult = window.claraverseStorageAPI.saveTable(table);
                logMessage(`üíæ R√©sultat sauvegarde: ${saveResult}`, saveResult ? 'success' : 'error');

                const storedIdAfterSave = table.getAttribute('data-robust-table-id');
                logMessage(`üîë ID stock√© sur table apr√®s sauvegarde: ${storedIdAfterSave}`, 'log');

                // V√©rifier les donn√©es dans localStorage
                if (storedIdAfterSave) {
                    const dataInStorage = localStorage.getItem(storedIdAfterSave);
                    if (dataInStorage) {
                        try {
                            const parsedData = JSON.parse(dataInStorage);
                            logMessage(`üíæ Donn√©es trouv√©es dans localStorage`, 'success');
                            logMessage(`üìä Taille HTML: ${parsedData.html ? parsedData.html.length : 0} chars`, 'log');
                            logMessage(`üìä Version: ${parsedData.metadata?.version || 'N/A'}`, 'log');
                            
                            // Analyser le contenu HTML sauvegard√©
                            if (parsedData.html) {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = parsedData.html;
                                const savedTable = tempDiv.querySelector('table');
                                if (savedTable) {
                                    const savedFirstCell = savedTable.querySelector('td');
                                    const savedContent = savedFirstCell ? savedFirstCell.textContent : '';
                                    logMessage(`üìã Contenu sauvegard√© dans HTML: "${savedContent}"`, 'log');
                                } else {
                                    logMessage(`‚ö†Ô∏è Pas de table trouv√©e dans HTML sauvegard√©`, 'warn');
                                }
                            }
                        } catch (e) {
                            logMessage(`‚ùå Donn√©es corrompues dans localStorage`, 'error');
                        }
                    } else {
                        logMessage(`‚ùå Aucune donn√©e trouv√©e dans localStorage pour ID: ${storedIdAfterSave}`, 'error');
                    }
                }

                // === PHASE 4: MODIFICATION TEMPORAIRE ===
                logMessage('üìã PHASE 4: MODIFICATION TEMPORAIRE', 'log');
                
                if (firstCell) {
                    firstCell.textContent = 'CONTENU_TEMPORAIRE_DEBUG';
                }
                logMessage(`üìù Contenu temporaire: "CONTENU_TEMPORAIRE_DEBUG"`, 'log');

                const storedIdBeforeRestore = table.getAttribute('data-robust-table-id');
                logMessage(`üîë ID stock√© sur table avant restauration: ${storedIdBeforeRestore}`, 'log');

                // === PHASE 5: RESTAURATION ===
                logMessage('üìã PHASE 5: RESTAURATION', 'log');
                
                const restoreResult = window.claraverseStorageAPI.restoreTable(table);
                logMessage(`üîÑ R√©sultat restauration: ${restoreResult}`, restoreResult ? 'success' : 'error');

                // === PHASE 6: V√âRIFICATION ===
                logMessage('üìã PHASE 6: V√âRIFICATION', 'log');
                
                const finalContent = firstCell ? firstCell.textContent : '';
                logMessage(`üìã Contenu final: "${finalContent}"`, 'log');

                const storedIdAfterRestore = table.getAttribute('data-robust-table-id');
                logMessage(`üîë ID stock√© sur table apr√®s restauration: ${storedIdAfterRestore}`, 'log');

                // === R√âSULTAT FINAL ===
                logMessage('üìã R√âSULTAT FINAL', 'log');
                
                if (finalContent === testContent) {
                    logMessage('‚úÖ RESTAURATION R√âUSSIE!', 'success');
                } else {
                    logMessage(`‚ùå RESTAURATION √âCHOU√âE`, 'error');
                    logMessage(`   Attendu: "${testContent}"`, 'error');
                    logMessage(`   Obtenu: "${finalContent}"`, 'error');
                }

                // === ANALYSE SUPPL√âMENTAIRE ===
                logMessage('üìã ANALYSE SUPPL√âMENTAIRE', 'log');
                
                // Lister toutes les cl√©s localStorage qui commencent par claraverse_table_
                let storageKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('claraverse_table_')) {
                        storageKeys.push(key);
                    }
                }
                logMessage(`üíæ ${storageKeys.length} cl√©(s) claraverse_table_ dans localStorage`, 'log');
                
                storageKeys.forEach((key, index) => {
                    logMessage(`   ${index + 1}. ${key.substring(0, 60)}...`, 'log');
                });

            } catch (error) {
                logMessage(`‚ùå Erreur globale: ${error.message}`, 'error');
                console.error('Erreur compl√®te:', error);
            }
        }

        function clearLog() {
            logDiv.innerHTML = 'Log effac√©...\n';
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('üöÄ Interface de debug d√©taill√© charg√©e', 'log');
            
            setTimeout(() => {
                if (typeof window.claraverseStorageAPI !== 'undefined') {
                    logMessage('‚úÖ API claraverseStorageAPI disponible', 'success');
                } else {
                    logMessage('‚ùå API claraverseStorageAPI non disponible', 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>