<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Correction Diff√©r√©e</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .test-table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        .test-table th,
        .test-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .test-table th {
            background-color: #f2f2f2;
        }

        .prose {
            max-width: none;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        button.success {
            background: #28a745;
        }

        .logs-container {
            background: #1e1e1e;
            color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-success {
            color: #4CAF50;
        }

        .log-error {
            color: #f44336;
        }

        .log-warning {
            color: #ff9800;
        }

        .log-info {
            color: #2196F3;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>‚è∞ Test Correction Diff√©r√©e</h1>
        <p>Test avec correction appliqu√©e apr√®s un d√©lai pour √©viter les interf√©rences</p>

        <div class="container">
            <h2>üéØ Tests Temporis√©s</h2>
            <button onclick="testDelayedCorrection()">‚è∞ Correction Diff√©r√©e</button>
            <button onclick="testMultipleDelays()">üîÑ D√©lais Multiples</button>
            <button onclick="testPersistentCorrection()">üîí Correction Persistante</button>
            <button onclick="clearLogs()">üßπ Effacer</button>
        </div>

        <div class="container">
            <h2>üìã Table de Test</h2>
            <div class="prose prose-base dark:prose-invert max-w-none">
                <table id="test-table" class="test-table min-w-full">
                    <thead>
                        <tr>
                            <th>Test</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Original</td>
                            <td>Data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="container">
            <h2>üìä Logs</h2>
            <div id="logs-display" class="logs-container">
                <div class="log-entry log-info">[INIT] Test de correction diff√©r√©e charg√©</div>
            </div>
        </div>
    </div>

    <!-- Charger le syst√®me de stockage -->
    <script src="menu_storage.js"></script>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;

            const logsContainer = document.getElementById('logs-display');
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs-display').innerHTML = '';
            log('Logs effac√©s', 'info');
        }

        // Fonction de correction avec d√©lai
        function applyDelayedCorrection(table, savedHTML, delay = 100) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    log(`‚è∞ Application correction apr√®s ${delay}ms...`, 'warning');

                    try {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(savedHTML, 'text/html');
                        const parsedTable = doc.querySelector('table');

                        if (parsedTable) {
                            // Copier cellule par cellule avec force
                            const originalCells = table.querySelectorAll('td, th');
                            const restoredCells = parsedTable.querySelectorAll('td, th');

                            for (let i = 0; i < Math.min(originalCells.length, restoredCells.length); i++) {
                                const restoredContent = restoredCells[i].textContent;
                                originalCells[i].textContent = restoredContent;
                                log(`‚è∞ Cellule ${i} forc√©e: "${restoredContent}"`, 'warning');
                            }

                            log('‚úÖ Correction diff√©r√©e appliqu√©e', 'success');
                            resolve(true);
                        } else {
                            log('‚ùå Erreur parsing HTML diff√©r√©', 'error');
                            resolve(false);
                        }
                    } catch (error) {
                        log(`‚ùå Erreur correction diff√©r√©e: ${error.message}`, 'error');
                        resolve(false);
                    }
                }, delay);
            });
        }

        async function testDelayedCorrection() {
            log('‚è∞ === TEST CORRECTION DIFF√âR√âE ===', 'info');

            try {
                const table = document.getElementById('test-table');
                const firstCell = table.querySelector('td');
                const testContent = 'DELAYED_' + Date.now();

                // Nettoyer et d√©finir contenu
                table.removeAttribute('data-robust-table-id');
                firstCell.textContent = testContent;
                log(`üìù Contenu d√©fini: "${testContent}"`, 'info');

                // Sauvegarder
                const saveResult = window.claraverseStorageAPI.saveTable(table);
                log(`üíæ Sauvegarde: ${saveResult ? 'SUCC√àS' : '√âCHEC'}`, saveResult ? 'success' : 'error');

                if (saveResult) {
                    const tableId = table.getAttribute('data-robust-table-id');
                    const savedDataStr = localStorage.getItem(tableId);

                    if (savedDataStr) {
                        const savedData = JSON.parse(savedDataStr);

                        // Modifier temporairement
                        firstCell.textContent = 'TEMP_DELAYED';
                        log(`üìù Contenu modifi√©: "${firstCell.textContent}"`, 'info');

                        // Appliquer correction avec d√©lai
                        log('‚è∞ Programmation correction dans 100ms...', 'info');
                        await applyDelayedCorrection(table, savedData.html, 100);

                        // V√©rifier imm√©diatement
                        const immediateContent = firstCell.textContent;
                        log(`üìã Contenu imm√©diat: "${immediateContent}"`, 'info');

                        // V√©rifier apr√®s un autre d√©lai
                        setTimeout(() => {
                            const finalContent = firstCell.textContent;
                            log(`üìã Contenu final (apr√®s 200ms): "${finalContent}"`, 'info');

                            if (finalContent === testContent) {
                                log('‚úÖ CORRECTION DIFF√âR√âE R√âUSSIE !', 'success');
                            } else {
                                log(`‚ùå CORRECTION DIFF√âR√âE √âCHOU√âE`, 'error');
                                log(`   Attendu: "${testContent}"`, 'error');
                                log(`   Obtenu:  "${finalContent}"`, 'error');
                            }
                        }, 200);
                    }
                }

            } catch (error) {
                log(`‚ùå ERREUR: ${error.message}`, 'error');
            }
        }

        async function testMultipleDelays() {
            log('üîÑ === TEST D√âLAIS MULTIPLES ===', 'info');

            try {
                const table = document.getElementById('test-table');
                const firstCell = table.querySelector('td');
                const testContent = 'MULTIPLE_DELAYS_' + Date.now();

                table.removeAttribute('data-robust-table-id');
                firstCell.textContent = testContent;
                log(`üìù Contenu d√©fini: "${testContent}"`, 'info');

                const saveResult = window.claraverseStorageAPI.saveTable(table);
                if (saveResult) {
                    const tableId = table.getAttribute('data-robust-table-id');
                    const savedDataStr = localStorage.getItem(tableId);

                    if (savedDataStr) {
                        const savedData = JSON.parse(savedDataStr);

                        firstCell.textContent = 'TEMP_MULTIPLE';
                        log(`üìù Contenu modifi√©: "${firstCell.textContent}"`, 'info');

                        // Essayer plusieurs d√©lais
                        const delays = [50, 100, 200, 500];

                        for (const delay of delays) {
                            log(`üîÑ Tentative avec d√©lai ${delay}ms...`, 'info');
                            await applyDelayedCorrection(table, savedData.html, delay);

                            // V√©rifier apr√®s chaque tentative
                            await new Promise(resolve => setTimeout(resolve, delay + 50));
                            const content = firstCell.textContent;
                            log(`üìã Contenu apr√®s ${delay}ms: "${content}"`, content === testContent ? 'success' : 'warning');

                            if (content === testContent) {
                                log(`‚úÖ SUCC√àS avec d√©lai ${delay}ms !`, 'success');
                                break;
                            }
                        }
                    }
                }

            } catch (error) {
                log(`‚ùå ERREUR: ${error.message}`, 'error');
            }
        }

        async function testPersistentCorrection() {
            log('üîí === TEST CORRECTION PERSISTANTE ===', 'info');

            try {
                const table = document.getElementById('test-table');
                const firstCell = table.querySelector('td');
                const testContent = 'PERSISTENT_' + Date.now();

                table.removeAttribute('data-robust-table-id');
                firstCell.textContent = testContent;
                log(`üìù Contenu d√©fini: "${testContent}"`, 'info');

                const saveResult = window.claraverseStorageAPI.saveTable(table);
                if (saveResult) {
                    const tableId = table.getAttribute('data-robust-table-id');
                    const savedDataStr = localStorage.getItem(tableId);

                    if (savedDataStr) {
                        const savedData = JSON.parse(savedDataStr);

                        firstCell.textContent = 'TEMP_PERSISTENT';
                        log(`üìù Contenu modifi√©: "${firstCell.textContent}"`, 'info');

                        // Correction persistante avec v√©rifications r√©p√©t√©es
                        let attempts = 0;
                        const maxAttempts = 10;

                        const persistentCorrection = () => {
                            attempts++;
                            log(`üîí Tentative persistante ${attempts}/${maxAttempts}...`, 'warning');

                            const currentContent = firstCell.textContent;
                            if (currentContent !== testContent && attempts <= maxAttempts) {
                                // Appliquer la correction
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(savedData.html, 'text/html');
                                const parsedTable = doc.querySelector('table');

                                if (parsedTable) {
                                    const restoredCells = parsedTable.querySelectorAll('td, th');
                                    const originalCells = table.querySelectorAll('td, th');

                                    for (let i = 0; i < Math.min(originalCells.length, restoredCells.length); i++) {
                                        originalCells[i].textContent = restoredCells[i].textContent;
                                    }

                                    log(`üîí Correction appliqu√©e (tentative ${attempts})`, 'warning');
                                }

                                // Programmer la prochaine v√©rification
                                setTimeout(persistentCorrection, 100);
                            } else if (currentContent === testContent) {
                                log(`‚úÖ CORRECTION PERSISTANTE R√âUSSIE apr√®s ${attempts} tentatives !`, 'success');
                            } else {
                                log(`‚ùå CORRECTION PERSISTANTE √âCHOU√âE apr√®s ${maxAttempts} tentatives`, 'error');
                            }
                        };

                        // D√©marrer la correction persistante
                        setTimeout(persistentCorrection, 100);
                    }
                }

            } catch (error) {
                log(`‚ùå ERREUR: ${error.message}`, 'error');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            log('‚è∞ Test de correction diff√©r√©e charg√©', 'success');
            log('üí° Ces tests appliquent la correction avec des d√©lais', 'info');
        });
    </script>
</body>

</html>